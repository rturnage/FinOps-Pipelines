{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "aubiAzureStorage_properties_typeProperties_serviceEndpoint": {
            "defaultValue": "@{concat('https://',linkedService().StorageAccountName,'.blob.core.windows.net')}",
            "type": "string"
        },
        "aubiKeyVault_properties_typeProperties_baseUrl": {
            "defaultValue": "https://@{linkedService().KeyVaultName}.vault.azure.net/",
            "type": "string"
        },
        "AubiSQLDatabase_connectionString": {
            "defaultValue": "Integrated Security=False;Encrypt=True;Connection Timeout=30;Data Source=@{linkedService().servername}.database.windows.net;Initial Catalog=@{linkedService().databasename}",
            "metadata": "Secure string for 'connectionString' of 'AubiSQLDatabase'",
            "type": "secureString"
        },
        "AzureManagementAPI_properties_typeProperties_aadResourceId": {
            "defaultValue": "https://management.azure.com/",
            "type": "string"
        },
        "AzureManagementAPI_properties_typeProperties_servicePrincipalId": {
            "defaultValue": "@{linkedService().servicePrincipalId}",
            "type": "string"
        },
        "AzureManagementAPI_properties_typeProperties_tenant": {
            "defaultValue": "@{linkedService().tenantId}",
            "type": "string"
        },
        "AzureManagementAPI_properties_typeProperties_url": {
            "defaultValue": "https://management.azure.com",
            "type": "string"
        },
        "DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_AdvisorAPIVersionGenerateRecs": {
            "defaultValue": "2017-04-19",
            "type": "string"
        },
        "DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_AdvisorAPIVersionGetRecs": {
            "defaultValue": "2020-01-01",
            "type": "string"
        },
        "DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_AdvisorGenerationWaitSecs": {
            "defaultValue": 600,
            "type": "int"
        },
        "DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_ConsumptionAPIVersion": {
            "defaultValue": "2019-10-01",
            "type": "string"
        },
        "DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_CostManagementExportsAPIVersion": {
            "defaultValue": "2021-01-01",
            "type": "string"
        },
        "DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_CostMangementReservationDetailsAPIVersion": {
            "defaultValue": "2019-11-01",
            "type": "string"
        },
        "DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_costopt_StorageDirectoryName": {
            "defaultValue": "download",
            "type": "string"
        },
        "DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_FullRefreshStartDate": {
            "defaultValue": "2021-01-01",
            "type": "string"
        },
        "DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_UsageExportDirectory": {
            "defaultValue": "download/usage",
            "type": "string"
        },
        "factoryName": {
            "defaultValue": "costoptadfqa",
            "metadata": "Data Factory name",
            "type": "string"
        },
        "HTTPFile_properties_typeProperties_url": {
            "defaultValue": "@{linkedService().FileURL}",
            "type": "string"
        }
    },
    "resources": [
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/aubiAzureStorage')]"
            ],
            "name": "[concat(parameters('factoryName'), '/AubiBinaryFile')]",
            "properties": {
                "annotations": [],
                "linkedServiceName": {
                    "parameters": {
                        "StorageAccountName": {
                            "type": "Expression",
                            "value": "@dataset().StorageAccountName"
                        }
                    },
                    "referenceName": "aubiAzureStorage",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "Container": {
                        "type": "string"
                    },
                    "Directory": {
                        "type": "string"
                    },
                    "FIleName": {
                        "type": "string"
                    },
                    "StorageAccountName": {
                        "type": "string"
                    }
                },
                "type": "Binary",
                "typeProperties": {
                    "location": {
                        "container": {
                            "type": "Expression",
                            "value": "@dataset().Container"
                        },
                        "fileName": {
                            "type": "Expression",
                            "value": "@dataset().FIleName"
                        },
                        "folderPath": {
                            "type": "Expression",
                            "value": "@dataset().Directory"
                        },
                        "type": "AzureBlobStorageLocation"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/datasets"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [],
            "name": "[concat(parameters('factoryName'), '/AubiSQLDatabase')]",
            "properties": {
                "annotations": [],
                "description": "Billing datasets are written to this Azure SQL Database",
                "parameters": {
                    "databasename": {
                        "defaultValue": "CMFDatabase",
                        "type": "string"
                    },
                    "servername": {
                        "defaultValue": "cfmSqlServer",
                        "type": "string"
                    }
                },
                "type": "AzureSqlDatabase",
                "typeProperties": {
                    "connectionString": "[parameters('AubiSQLDatabase_connectionString')]"
                }
            },
            "type": "Microsoft.DataFactory/factories/linkedServices"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/aubiKeyVault')]"
            ],
            "name": "[concat(parameters('factoryName'), '/AzureManagementAPI')]",
            "properties": {
                "annotations": [],
                "parameters": {
                    "KeyVaultName": {
                        "defaultValue": "<KeyVaultName>",
                        "type": "string"
                    },
                    "servicePrincipalId": {
                        "type": "string"
                    },
                    "servicePrincipalSecretKeyName": {
                        "defaultValue": "aubi-serviceprincipalsecret",
                        "type": "string"
                    },
                    "tenantId": {
                        "type": "string"
                    }
                },
                "type": "RestService",
                "typeProperties": {
                    "aadResourceId": "[parameters('AzureManagementAPI_properties_typeProperties_aadResourceId')]",
                    "authenticationType": "AadServicePrincipal",
                    "enableServerCertificateValidation": true,
                    "servicePrincipalId": "[parameters('AzureManagementAPI_properties_typeProperties_servicePrincipalId')]",
                    "servicePrincipalKey": {
                        "secretName": {
                            "type": "Expression",
                            "value": "@{linkedService().servicePrincipalSecretKeyName}"
                        },
                        "store": {
                            "parameters": {
                                "KeyVaultName": {
                                    "type": "Expression",
                                    "value": "@linkedService().KeyVaultName"
                                }
                            },
                            "referenceName": "aubiKeyVault",
                            "type": "LinkedServiceReference"
                        },
                        "type": "AzureKeyVaultSecret"
                    },
                    "tenant": "[parameters('AzureManagementAPI_properties_typeProperties_tenant')]",
                    "url": "[parameters('AzureManagementAPI_properties_typeProperties_url')]"
                }
            },
            "type": "Microsoft.DataFactory/factories/linkedServices"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/aubiAzureStorage')]"
            ],
            "name": "[concat(parameters('factoryName'), '/Binary1')]",
            "properties": {
                "annotations": [],
                "linkedServiceName": {
                    "parameters": {
                        "StorageAccountName": {
                            "type": "Expression",
                            "value": "@dataset().StorageAccountName"
                        }
                    },
                    "referenceName": "aubiAzureStorage",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "Container": {
                        "type": "string"
                    },
                    "Directory": {
                        "type": "string"
                    },
                    "StorageAccountName": {
                        "type": "string"
                    }
                },
                "type": "Binary",
                "typeProperties": {
                    "location": {
                        "container": {
                            "type": "Expression",
                            "value": "@dataset().Container"
                        },
                        "folderPath": {
                            "type": "Expression",
                            "value": "@dataset().Directory"
                        },
                        "type": "AzureBlobStorageLocation"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/datasets"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/aubiAzureStorage')]"
            ],
            "name": "[concat(parameters('factoryName'), '/CSVFileDataset')]",
            "properties": {
                "annotations": [],
                "description": "Generic CSV Dataset used in a number of aubi pipelines.\n",
                "folder": {
                    "name": "ProcessUsageData"
                },
                "linkedServiceName": {
                    "parameters": {
                        "StorageAccountName": {
                            "type": "Expression",
                            "value": "@dataset().StorageAccount"
                        }
                    },
                    "referenceName": "aubiAzureStorage",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "Container": {
                        "type": "string"
                    },
                    "Directory": {
                        "type": "string"
                    },
                    "File": {
                        "type": "string"
                    },
                    "StorageAccount": {
                        "type": "string"
                    }
                },
                "schema": [],
                "type": "DelimitedText",
                "typeProperties": {
                    "columnDelimiter": ",",
                    "escapeChar": "\"",
                    "firstRowAsHeader": true,
                    "location": {
                        "container": {
                            "type": "Expression",
                            "value": "@dataset().Container"
                        },
                        "fileName": {
                            "type": "Expression",
                            "value": "@dataset().File"
                        },
                        "folderPath": {
                            "type": "Expression",
                            "value": "@dataset().Directory"
                        },
                        "type": "AzureBlobStorageLocation"
                    },
                    "quoteChar": "\""
                }
            },
            "type": "Microsoft.DataFactory/factories/datasets"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/pipelines/LoadConsumptionDataToDatabase')]",
                "[concat(variables('factoryId'), '/linkedServices/aubiKeyVault')]"
            ],
            "name": "[concat(parameters('factoryName'), '/CreateAndRunUsageExport')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "DeleteNamedExport_Pre",
                                "dependencyConditions": [
                                    "Completed"
                                ]
                            }
                        ],
                        "description": "Make a call to the ExportAPI to export usage details for a date range specified by pipeline params.",
                        "name": "CreateExport",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 60,
                            "secureInput": true,
                            "secureOutput": false,
                            "timeout": "0.00:02:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "password": {
                                    "secretName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                    },
                                    "store": {
                                        "parameters": {
                                            "KeyVaultName": {
                                                "type": "Expression",
                                                "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                            }
                                        },
                                        "referenceName": "aubiKeyVault",
                                        "type": "LinkedServiceReference"
                                    },
                                    "type": "AzureKeyVaultSecret"
                                },
                                "resource": "https://management.azure.com",
                                "type": "ServicePrincipal",
                                "userTenant": {
                                    "type": "Expression",
                                    "value": "@activity('GetTenantId').output.value"
                                },
                                "username": {
                                    "type": "Expression",
                                    "value": "@activity('GetClientId').output.value"
                                }
                            },
                            "body": {
                                "type": "Expression",
                                "value": "@variables('body')"
                            },
                            "headers": {},
                            "method": "PUT",
                            "url": {
                                "type": "Expression",
                                "value": "@concat('https://management.azure.com/', pipeline().parameters.scope, '/providers/Microsoft.CostManagement/exports/',pipeline().parameters.exportName,'?api-version=',pipeline().parameters.CostManagementApiVersion)"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "PollUntilExportComplete",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "description": "Make a call to the ExportAPI to delete the named export",
                        "name": "DeleteNamedExport_Post",
                        "policy": {
                            "retry": 5,
                            "retryIntervalInSeconds": 60,
                            "secureInput": true,
                            "secureOutput": false,
                            "timeout": "0.00:02:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "password": {
                                    "secretName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                    },
                                    "store": {
                                        "parameters": {
                                            "KeyVaultName": {
                                                "type": "Expression",
                                                "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                            }
                                        },
                                        "referenceName": "aubiKeyVault",
                                        "type": "LinkedServiceReference"
                                    },
                                    "type": "AzureKeyVaultSecret"
                                },
                                "resource": "https://management.azure.com",
                                "type": "ServicePrincipal",
                                "userTenant": {
                                    "type": "Expression",
                                    "value": "@activity('GetTenantId').output.value"
                                },
                                "username": {
                                    "type": "Expression",
                                    "value": "@activity('GetClientId').output.value"
                                }
                            },
                            "body": "x",
                            "headers": {},
                            "method": "DELETE",
                            "url": {
                                "type": "Expression",
                                "value": "@concat('https://management.azure.com/', pipeline().parameters.scope, '/providers/Microsoft.CostManagement/exports/',pipeline().parameters.exportName,'?api-version=',pipeline().parameters.CostManagementApiVersion)"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "CreateExport",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "PollUntilExportComplete",
                        "type": "Until",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "Wait For Export",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "GetExportRunStatus",
                                    "policy": {
                                        "retry": 0,
                                        "retryIntervalInSeconds": 30,
                                        "secureInput": false,
                                        "secureOutput": false,
                                        "timeout": "7.00:00:00"
                                    },
                                    "type": "WebActivity",
                                    "typeProperties": {
                                        "authentication": {
                                            "password": {
                                                "secretName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                                },
                                                "store": {
                                                    "parameters": {
                                                        "KeyVaultName": {
                                                            "type": "Expression",
                                                            "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                                        }
                                                    },
                                                    "referenceName": "aubiKeyVault",
                                                    "type": "LinkedServiceReference"
                                                },
                                                "type": "AzureKeyVaultSecret"
                                            },
                                            "resource": "https://management.azure.com",
                                            "type": "ServicePrincipal",
                                            "userTenant": {
                                                "type": "Expression",
                                                "value": "@activity('GetTenantId').output.value"
                                            },
                                            "username": {
                                                "type": "Expression",
                                                "value": "@activity('GetClientId').output.value"
                                            }
                                        },
                                        "headers": {},
                                        "method": "GET",
                                        "url": {
                                            "type": "Expression",
                                            "value": "@concat('https://management.azure.com/', pipeline().parameters.scope, '/providers/Microsoft.CostManagement/exports/',pipeline().parameters.exportName,'/runHistory?api-version=',pipeline().parameters.CostManagementApiVersion)"
                                        }
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "Set Status WAIT",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "Wait For Export",
                                    "type": "Wait",
                                    "typeProperties": {
                                        "waitTimeInSeconds": {
                                            "type": "Expression",
                                            "value": "@pipeline().parameters.ExportStatusCheckLoopTime"
                                        }
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "GetExportRunStatus",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "UpdateExportRunStatus",
                                    "type": "Switch",
                                    "typeProperties": {
                                        "cases": [
                                            {
                                                "activities": [
                                                    {
                                                        "dependsOn": [],
                                                        "name": "Set Status COMPLETED",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": "COMPLETED",
                                                            "variableName": "PollingStatus"
                                                        },
                                                        "userProperties": []
                                                    },
                                                    {
                                                        "dependsOn": [
                                                            {
                                                                "activity": "Set Status COMPLETED",
                                                                "dependencyConditions": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        ],
                                                        "name": "Set Exported Filename",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@string(activity('GetExportRunStatus').output.value[0].properties.fileName)"
                                                            },
                                                            "variableName": "ExportedFilename"
                                                        },
                                                        "userProperties": []
                                                    }
                                                ],
                                                "value": "Completed"
                                            },
                                            {
                                                "activities": [
                                                    {
                                                        "dependsOn": [],
                                                        "name": "Failed - Set Status FAILED",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": "FAILED",
                                                            "variableName": "PollingStatus"
                                                        },
                                                        "userProperties": []
                                                    },
                                                    {
                                                        "dependsOn": [
                                                            {
                                                                "activity": "Failed - Set Status FAILED",
                                                                "dependencyConditions": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        ],
                                                        "name": "Failed - Increment Failure Count Temp Variable",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@string(add(int(variables('ExportExecutionRetries')), 1))"
                                                            },
                                                            "variableName": "TempRetries"
                                                        },
                                                        "userProperties": []
                                                    },
                                                    {
                                                        "dependsOn": [
                                                            {
                                                                "activity": "Failed - Increment Failure Count Temp Variable",
                                                                "dependencyConditions": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        ],
                                                        "name": "Failed - Increment Failure Count",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@variables('TempRetries')"
                                                            },
                                                            "variableName": "ExportExecutionRetries"
                                                        },
                                                        "userProperties": []
                                                    }
                                                ],
                                                "value": "Failed"
                                            },
                                            {
                                                "activities": [
                                                    {
                                                        "dependsOn": [],
                                                        "name": "Timeout - Set Status FAILED",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": "FAILED",
                                                            "variableName": "PollingStatus"
                                                        },
                                                        "userProperties": []
                                                    },
                                                    {
                                                        "dependsOn": [
                                                            {
                                                                "activity": "Timeout - Increment Failure Count Temp Variable",
                                                                "dependencyConditions": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        ],
                                                        "name": "Timeout - Increment Failure Count",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@string(add(int(variables('ExportExecutionRetries')), 1))"
                                                            },
                                                            "variableName": "TempRetries"
                                                        },
                                                        "userProperties": []
                                                    },
                                                    {
                                                        "dependsOn": [
                                                            {
                                                                "activity": "Timeout - Set Status FAILED",
                                                                "dependencyConditions": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        ],
                                                        "name": "Timeout - Increment Failure Count Temp Variable",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@string(add(int(variables('ExportExecutionRetries')), 1))"
                                                            },
                                                            "variableName": "TempRetries"
                                                        },
                                                        "userProperties": []
                                                    }
                                                ],
                                                "value": "Timeout"
                                            },
                                            {
                                                "activities": [
                                                    {
                                                        "dependsOn": [],
                                                        "name": "Data Not Avail - Set Status FAILED",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": "FAILED",
                                                            "variableName": "PollingStatus"
                                                        },
                                                        "userProperties": []
                                                    },
                                                    {
                                                        "dependsOn": [
                                                            {
                                                                "activity": "Data Not Avail - Increment Failure Count Temp Variable",
                                                                "dependencyConditions": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        ],
                                                        "name": "Data Not Avail - Increment Failure Count",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@string(add(int(variables('ExportExecutionRetries')), 1))"
                                                            },
                                                            "variableName": "TempRetries"
                                                        },
                                                        "userProperties": []
                                                    },
                                                    {
                                                        "dependsOn": [
                                                            {
                                                                "activity": "Data Not Avail - Set Status FAILED",
                                                                "dependencyConditions": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        ],
                                                        "name": "Data Not Avail - Increment Failure Count Temp Variable",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@variables('TempRetries')"
                                                            },
                                                            "variableName": "ExportExecutionRetries"
                                                        },
                                                        "userProperties": []
                                                    }
                                                ],
                                                "value": "DataNotAvailable"
                                            },
                                            {
                                                "activities": [
                                                    {
                                                        "dependsOn": [],
                                                        "name": "NewDataNotAvail - Set Status FAILED",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": "FAILED",
                                                            "variableName": "PollingStatus"
                                                        },
                                                        "userProperties": []
                                                    },
                                                    {
                                                        "dependsOn": [
                                                            {
                                                                "activity": "NewDataNotAvail - Increment Failure Count Temp Variable",
                                                                "dependencyConditions": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        ],
                                                        "name": "NewDataNotAvail - Increment Failure Count",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@string(add(int(variables('ExportExecutionRetries')), 1))"
                                                            },
                                                            "variableName": "TempRetries"
                                                        },
                                                        "userProperties": []
                                                    },
                                                    {
                                                        "dependsOn": [
                                                            {
                                                                "activity": "NewDataNotAvail - Set Status FAILED",
                                                                "dependencyConditions": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        ],
                                                        "name": "NewDataNotAvail - Increment Failure Count Temp Variable",
                                                        "type": "SetVariable",
                                                        "typeProperties": {
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@variables('TempRetries')"
                                                            },
                                                            "variableName": "ExportExecutionRetries"
                                                        },
                                                        "userProperties": []
                                                    }
                                                ],
                                                "value": "NewDataNotAvailable"
                                            }
                                        ],
                                        "on": {
                                            "type": "Expression",
                                            "value": "@string(activity('GetExportRunStatus').output.value[0].properties.status)"
                                        }
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "CheckExecuteExport",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "Set Status WAIT",
                                    "type": "SetVariable",
                                    "typeProperties": {
                                        "value": "WAIT",
                                        "variableName": "PollingStatus"
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [],
                                    "name": "CheckExecuteExport",
                                    "type": "IfCondition",
                                    "typeProperties": {
                                        "expression": {
                                            "type": "Expression",
                                            "value": "@and(or(equals(variables('PollingStatus'),'NOTSTARTED'),equals(variables('PollingStatus'),'FAILED')),lessOrEquals(int(variables('ExportExecutionRetries')),int(pipeline().parameters.MaxExportExecutionRetries)))"
                                        },
                                        "ifTrueActivities": [
                                            {
                                                "dependsOn": [],
                                                "description": "Make a call to the ExportAPI to export usage details for a date range specified by pipeline params.",
                                                "name": "RunNamedExport",
                                                "policy": {
                                                    "retry": 5,
                                                    "retryIntervalInSeconds": 60,
                                                    "secureInput": true,
                                                    "secureOutput": false,
                                                    "timeout": "0.00:02:00"
                                                },
                                                "type": "WebActivity",
                                                "typeProperties": {
                                                    "authentication": {
                                                        "password": {
                                                            "secretName": {
                                                                "type": "Expression",
                                                                "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                                            },
                                                            "store": {
                                                                "parameters": {
                                                                    "KeyVaultName": {
                                                                        "type": "Expression",
                                                                        "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                                                    }
                                                                },
                                                                "referenceName": "aubiKeyVault",
                                                                "type": "LinkedServiceReference"
                                                            },
                                                            "type": "AzureKeyVaultSecret"
                                                        },
                                                        "resource": "https://management.azure.com",
                                                        "type": "ServicePrincipal",
                                                        "userTenant": {
                                                            "type": "Expression",
                                                            "value": "@activity('GetTenantId').output.value"
                                                        },
                                                        "username": {
                                                            "type": "Expression",
                                                            "value": "@activity('GetClientId').output.value"
                                                        }
                                                    },
                                                    "body": "x",
                                                    "headers": {},
                                                    "method": "POST",
                                                    "url": {
                                                        "type": "Expression",
                                                        "value": "@concat('https://management.azure.com/', pipeline().parameters.scope, '/providers/Microsoft.CostManagement/exports/',pipeline().parameters.exportName,'/run?api-version=',pipeline().parameters.CostManagementApiVersion)"
                                                    }
                                                },
                                                "userProperties": []
                                            }
                                        ]
                                    },
                                    "userProperties": []
                                }
                            ],
                            "expression": {
                                "type": "Expression",
                                "value": "@not(equals(variables('PollingStatus'),'WAIT'))"
                            },
                            "timeout": "0.01:00:00"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "SetExportAPIBody",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "description": "Make a call to the ExportAPI to delete the named export",
                        "name": "DeleteNamedExport_Pre",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": true,
                            "secureOutput": false,
                            "timeout": "0.00:02:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "password": {
                                    "secretName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                    },
                                    "store": {
                                        "parameters": {
                                            "KeyVaultName": {
                                                "type": "Expression",
                                                "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                            }
                                        },
                                        "referenceName": "aubiKeyVault",
                                        "type": "LinkedServiceReference"
                                    },
                                    "type": "AzureKeyVaultSecret"
                                },
                                "resource": "https://management.azure.com",
                                "type": "ServicePrincipal",
                                "userTenant": {
                                    "type": "Expression",
                                    "value": "@activity('GetTenantId').output.value"
                                },
                                "username": {
                                    "type": "Expression",
                                    "value": "@activity('GetClientId').output.value"
                                }
                            },
                            "body": "x",
                            "headers": {},
                            "method": "DELETE",
                            "url": {
                                "type": "Expression",
                                "value": "@concat('https://management.azure.com/', pipeline().parameters.scope, '/providers/Microsoft.CostManagement/exports/',pipeline().parameters.exportName,'?api-version=',pipeline().parameters.CostManagementApiVersion)"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "SetStorageAcctResourcePath",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "SetExportAPIBody",
                        "type": "SetVariable",
                        "typeProperties": {
                            "value": {
                                "type": "Expression",
                                "value": "@concat(\n'{\"properties\": {\"schedule\": {\"status\": \"Inactive\",},\"format\": \"Csv\",\"deliveryInfo\": {\"destination\":{\"resourceId\":\"'\n, variables('StorageAccountResourcePath')\n,'\",\"container\": \"'\n,pipeline().globalParameters.costopt_Container\n,'\",\"rootFolderPath\": \"'\n,pipeline().parameters.UsageDownload_StorageBlobDirectory\n,'\"}},\"definition\": {\"type\": \"'\n,pipeline().parameters.ExportType\n,'\",\"timeframe\": \"'\n,pipeline().parameters.ExportTimeframe\n,'\",'\n,if(equals(pipeline().parameters.ExportTimeframe,'Custom'),concat('\"timePeriod\":{\"from\":\"',pipeline().parameters.StartDate,'\",\"to\":\"',pipeline().parameters.EndDate,'\"},'),'')\n,'\"dataSet\": {\"granularity\": \"Daily\"}}}}'\n)"
                            },
                            "variableName": "body"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "SetStorageAcctResourcePath",
                        "type": "SetVariable",
                        "typeProperties": {
                            "value": {
                                "type": "Expression",
                                "value": "/subscriptions/@{pipeline().globalParameters.costopt_StorageAccountSubscriptionId}/resourceGroups/@{pipeline().globalParameters.costopt_ResourceGroupName}/providers/Microsoft.Storage/storageAccounts/@{pipeline().globalParameters.costopt_StorageAccountName}"
                            },
                            "variableName": "StorageAccountResourcePath"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "DeleteNamedExport_Post",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "LoadUsageFileToDatabase",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "EndDate": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.EndDate"
                                },
                                "StartDate": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.StartDate"
                                },
                                "TargetSchemaName": "costmanagement",
                                "TargetTableName": {
                                    "type": "Expression",
                                    "value": "@if(equals(pipeline().parameters.ExportType,'ActualCost'),'ActualCost','AmortizedCost')"
                                },
                                "UsageDownload_Filename": {
                                    "type": "Expression",
                                    "value": "@variables('ExportedFilename')"
                                }
                            },
                            "pipeline": {
                                "referenceName": "LoadConsumptionDataToDatabase",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "UsageData"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "CostManagementApiVersion": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "EndDate": {
                        "defaultValue": "2021-09-02",
                        "type": "string"
                    },
                    "ExportStatusCheckLoopTime": {
                        "defaultValue": 60,
                        "type": "int"
                    },
                    "ExportTimeframe": {
                        "defaultValue": "Custom",
                        "type": "string"
                    },
                    "ExportType": {
                        "defaultValue": "ActualCost",
                        "type": "string"
                    },
                    "MaxExportExecutionRetries": {
                        "defaultValue": 3,
                        "type": "int"
                    },
                    "StartDate": {
                        "defaultValue": "2021-09-01",
                        "type": "string"
                    },
                    "UsageDownload_StorageBlobDirectory": {
                        "defaultValue": "download/usage",
                        "type": "string"
                    },
                    "exportName": {
                        "defaultValue": "msftExportUsageTemp",
                        "type": "string"
                    },
                    "scope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/<BillingAccountNum>",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                },
                "variables": {
                    "ExportExecutionRetries": {
                        "defaultValue": "0",
                        "type": "String"
                    },
                    "ExportedFilename": {
                        "type": "String"
                    },
                    "PollingStatus": {
                        "defaultValue": "NOTSTARTED",
                        "type": "String"
                    },
                    "StorageAccountResourcePath": {
                        "type": "String"
                    },
                    "TempRetries": {
                        "defaultValue": "0",
                        "type": "String"
                    },
                    "body": {
                        "type": "String"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/pipelines/RefreshAllData_ExistingExports')]"
            ],
            "name": "[concat(parameters('factoryName'), '/DailyOvernightProcessing')]",
            "properties": {
                "annotations": [],
                "pipelines": [
                    {
                        "parameters": {
                            "AdvisorAPIVersionGenerateRecs": "[parameters('DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_AdvisorAPIVersionGenerateRecs')]",
                            "AdvisorAPIVersionGetRecs": "[parameters('DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_AdvisorAPIVersionGetRecs')]",
                            "AdvisorGenerationWaitSecs": "[parameters('DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_AdvisorGenerationWaitSecs')]",
                            "ConsumptionAPIVersion": "[parameters('DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_ConsumptionAPIVersion')]",
                            "CostManagementExportsAPIVersion": "[parameters('DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_CostManagementExportsAPIVersion')]",
                            "CostMangementReservationDetailsAPIVersion": "[parameters('DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_CostMangementReservationDetailsAPIVersion')]",
                            "FullRefreshStartDate": "[parameters('DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_FullRefreshStartDate')]",
                            "UsageExportDirectory": "[parameters('DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_UsageExportDirectory')]",
                            "costopt_StorageDirectoryName": "[parameters('DailyOvernightProcessing_properties_RefreshAllData_ExistingExports_parameters_costopt_StorageDirectoryName')]"
                        },
                        "pipelineReference": {
                            "referenceName": "RefreshAllData_ExistingExports",
                            "type": "PipelineReference"
                        }
                    }
                ],
                "runtimeState": "Started",
                "type": "ScheduleTrigger",
                "typeProperties": {
                    "recurrence": {
                        "frequency": "Day",
                        "interval": 1,
                        "schedule": {},
                        "startTime": "2023-02-14T01:00:00Z",
                        "timeZone": "UTC"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/triggers"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/aubiKeyVault')]"
            ],
            "name": "[concat(parameters('factoryName'), '/DeleteNamedExport')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "ForEach1",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "description": "Make a call to the ExportAPI to delete the named export",
                                    "name": "DeleteNamedExport_Pre",
                                    "policy": {
                                        "retry": 0,
                                        "retryIntervalInSeconds": 30,
                                        "secureInput": false,
                                        "secureOutput": false,
                                        "timeout": "0.00:02:00"
                                    },
                                    "type": "WebActivity",
                                    "typeProperties": {
                                        "authentication": {
                                            "password": {
                                                "secretName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                                },
                                                "store": {
                                                    "parameters": {
                                                        "KeyVaultName": {
                                                            "type": "Expression",
                                                            "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                                        }
                                                    },
                                                    "referenceName": "aubiKeyVault",
                                                    "type": "LinkedServiceReference"
                                                },
                                                "type": "AzureKeyVaultSecret"
                                            },
                                            "resource": "https://management.azure.com",
                                            "type": "ServicePrincipal",
                                            "userTenant": {
                                                "type": "Expression",
                                                "value": "@activity('GetTenantId').output.value"
                                            },
                                            "username": {
                                                "type": "Expression",
                                                "value": "@activity('GetClientId').output.value"
                                            }
                                        },
                                        "body": "x",
                                        "headers": {},
                                        "method": "DELETE",
                                        "url": {
                                            "type": "Expression",
                                            "value": "@concat('https://management.azure.com/', pipeline().parameters.scope, '/providers/Microsoft.CostManagement/exports/',item(),'?api-version=',pipeline().parameters.CostManagementApiVersion)"
                                        }
                                    },
                                    "userProperties": []
                                }
                            ],
                            "items": {
                                "type": "Expression",
                                "value": "@pipeline().parameters.exportNameArray"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "UsageData"
                },
                "lastPublishTime": "2022-10-22T21:36:23Z",
                "parameters": {
                    "CostManagementApiVersion": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "exportNameArray": {
                        "defaultValue": [
                            "<ExportName1>",
                            "<ExportName2>"
                        ],
                        "type": "array"
                    },
                    "scope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/<BillingAccountNum>",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/JsonDataset')]",
                "[concat(variables('factoryId'), '/pipelines/GetRecommendationsForSub')]",
                "[concat(variables('factoryId'), '/linkedServices/aubiKeyVault')]"
            ],
            "name": "[concat(parameters('factoryName'), '/GetAdvisorData')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [
                            {
                                "activity": "WebActivityGetSubscriptions",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GenerateRecommendationsForEachSubscription",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "name": "WebActivityGenerateRecommendations",
                                    "policy": {
                                        "retry": 0,
                                        "retryIntervalInSeconds": 30,
                                        "secureInput": false,
                                        "secureOutput": false,
                                        "timeout": "7.00:00:00"
                                    },
                                    "type": "WebActivity",
                                    "typeProperties": {
                                        "authentication": {
                                            "password": {
                                                "secretName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                                },
                                                "store": {
                                                    "parameters": {
                                                        "KeyVaultName": {
                                                            "type": "Expression",
                                                            "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                                        }
                                                    },
                                                    "referenceName": "aubiKeyVault",
                                                    "type": "LinkedServiceReference"
                                                },
                                                "type": "AzureKeyVaultSecret"
                                            },
                                            "resource": "https://management.azure.com",
                                            "type": "ServicePrincipal",
                                            "userTenant": {
                                                "type": "Expression",
                                                "value": "@activity('GetTenantId').output.value"
                                            },
                                            "username": {
                                                "type": "Expression",
                                                "value": "@activity('GetClientId').output.value"
                                            }
                                        },
                                        "body": "x",
                                        "headers": {},
                                        "method": "POST",
                                        "url": {
                                            "type": "Expression",
                                            "value": "https://management.azure.com/subscriptions/@{item().subscriptionId}/providers/Microsoft.Advisor/generateRecommendations?api-version=@{pipeline().parameters.AdvisorAPIVersionGenerateRecs}"
                                        }
                                    },
                                    "userProperties": []
                                }
                            ],
                            "items": {
                                "type": "Expression",
                                "value": "@activity('WebActivityGetSubscriptions').output.value"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "WaitForGeneration",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "DownloadRecommendationsForEachSub",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "name": "GetRecommendationsForSub",
                                    "type": "ExecutePipeline",
                                    "typeProperties": {
                                        "parameters": {
                                            "DownloadTargetFilename": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.DownloadTargetFilename"
                                            },
                                            "Download_StorageBlobContainer": {
                                                "type": "Expression",
                                                "value": "@pipeline().globalParameters.costopt_Container"
                                            },
                                            "Download_StorageBlobDirectory": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                            },
                                            "RecommendationsAPIVersion": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.AdvisorAPIVersionGetRecs"
                                            },
                                            "SubscriptionId": {
                                                "type": "Expression",
                                                "value": "@item().subscriptionId"
                                            },
                                            "WaitTimeSecs": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.AdvisorLoopWaitTimeSecs"
                                            }
                                        },
                                        "pipeline": {
                                            "referenceName": "GetRecommendationsForSub",
                                            "type": "PipelineReference"
                                        },
                                        "waitOnCompletion": true
                                    },
                                    "userProperties": []
                                }
                            ],
                            "isSequential": false,
                            "items": {
                                "type": "Expression",
                                "value": "@activity('WebActivityGetSubscriptions').output.value"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "WebActivityGetSubscriptions",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "password": {
                                    "secretName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                    },
                                    "store": {
                                        "parameters": {
                                            "KeyVaultName": {
                                                "type": "Expression",
                                                "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                            }
                                        },
                                        "referenceName": "aubiKeyVault",
                                        "type": "LinkedServiceReference"
                                    },
                                    "type": "AzureKeyVaultSecret"
                                },
                                "resource": "https://management.azure.com",
                                "type": "ServicePrincipal",
                                "userTenant": {
                                    "type": "Expression",
                                    "value": "@activity('GetTenantId').output.value"
                                },
                                "username": {
                                    "type": "Expression",
                                    "value": "@activity('GetClientId').output.value"
                                }
                            },
                            "headers": {},
                            "method": "GET",
                            "url": "https://management.azure.com/subscriptions?api-version=2020-01-01"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GenerateRecommendationsForEachSubscription",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "WaitForGeneration",
                        "type": "Wait",
                        "typeProperties": {
                            "waitTimeInSeconds": {
                                "type": "Expression",
                                "value": "@pipeline().parameters.GenerationWaitTimeSecs"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "DownloadRecommendationsForEachSub",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "DeleteTargetFileIfItExists",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "NotNeeded"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "MergeFiles",
                        "outputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@concat(pipeline().parameters.Download_StorageBlobDirectory,'/merged')"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "formatSettings": {
                                    "filePattern": "arrayOfObjects",
                                    "type": "JsonWriteSettings"
                                },
                                "storeSettings": {
                                    "copyBehavior": "MergeFiles",
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "type": "JsonSink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "JsonReadSettings"
                                },
                                "storeSettings": {
                                    "enablePartitionDiscovery": false,
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings",
                                    "wildcardFileName": "*.json",
                                    "wildcardFolderPath": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                    }
                                },
                                "type": "JsonSource"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "CheckTargetFile",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "GetMetadata",
                        "typeProperties": {
                            "dataset": {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@concat(pipeline().parameters.Download_StorageBlobDirectory,'/merged')"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            },
                            "fieldList": [
                                "exists"
                            ],
                            "formatSettings": {
                                "type": "JsonReadSettings"
                            },
                            "storeSettings": {
                                "recursive": true,
                                "type": "AzureBlobStorageReadSettings"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "CheckTargetFile",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "DeleteTargetFileIfItExists",
                        "type": "IfCondition",
                        "typeProperties": {
                            "expression": {
                                "type": "Expression",
                                "value": "@bool(activity('CheckTargetFile').output.exists)"
                            },
                            "ifTrueActivities": [
                                {
                                    "dependsOn": [],
                                    "name": "DeleteTargetFile",
                                    "policy": {
                                        "retry": 0,
                                        "retryIntervalInSeconds": 30,
                                        "secureInput": false,
                                        "secureOutput": false,
                                        "timeout": "7.00:00:00"
                                    },
                                    "type": "Delete",
                                    "typeProperties": {
                                        "dataset": {
                                            "parameters": {
                                                "Container": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_Container"
                                                },
                                                "Directory": {
                                                    "type": "Expression",
                                                    "value": "@concat(pipeline().parameters.Download_StorageBlobDirectory,'/merged')"
                                                },
                                                "FileName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().parameters.DownloadTargetFilename"
                                                },
                                                "StorageAccountName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                                }
                                            },
                                            "referenceName": "JsonDataset",
                                            "type": "DatasetReference"
                                        },
                                        "enableLogging": false,
                                        "storeSettings": {
                                            "recursive": true,
                                            "type": "AzureBlobStorageReadSettings"
                                        }
                                    },
                                    "userProperties": []
                                }
                            ]
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "Advisor"
                },
                "lastPublishTime": "2023-02-24T18:31:40Z",
                "parameters": {
                    "AdvisorAPIVersionGenerateRecs": {
                        "defaultValue": "2017-04-19",
                        "type": "string"
                    },
                    "AdvisorAPIVersionGetRecs": {
                        "defaultValue": "2020-01-01",
                        "type": "string"
                    },
                    "AdvisorLoopWaitTimeSecs": {
                        "defaultValue": 120,
                        "type": "int"
                    },
                    "DownloadTargetFilename": {
                        "defaultValue": "advisor.json",
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "defaultValue": "download/advisor",
                        "type": "string"
                    },
                    "GenerationWaitTimeSecs": {
                        "defaultValue": 120,
                        "type": "int"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/HTTPFile')]",
                "[concat(variables('factoryId'), '/datasets/AubiBinaryFile')]"
            ],
            "name": "[concat(parameters('factoryName'), '/GetISFRatioDataPipeline')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "inputs": [
                            {
                                "parameters": {
                                    "FileURL": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.ISFFileURL"
                                    }
                                },
                                "referenceName": "HTTPFile",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "CopyISFRatioData",
                        "outputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                    },
                                    "FIleName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "AubiBinaryFile",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "type": "BinarySink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                },
                                "storeSettings": {
                                    "requestMethod": "GET",
                                    "type": "HttpReadSettings"
                                },
                                "type": "BinarySource"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "ISFRatio"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "DownloadTargetFilename": {
                        "defaultValue": "isfratio.csv",
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "defaultValue": "download/isfratio",
                        "type": "string"
                    },
                    "ISFFileURL": {
                        "defaultValue": "https://isfratio.blob.core.windows.net/isfratio/ISFRatio.csv",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/ManagementAPIDataSet')]",
                "[concat(variables('factoryId'), '/datasets/JsonDataset')]"
            ],
            "name": "[concat(parameters('factoryName'), '/GetMarketplaceData')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "inputs": [
                            {
                                "parameters": {
                                    "KeyVaultName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                    },
                                    "api": "providers/Microsoft.Consumption/marketplaces",
                                    "apiversion": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                    },
                                    "filter": {
                                        "type": "Expression",
                                        "value": "&$filter=properties/usageStart ge '@{pipeline().parameters.UsageStartDate}' and properties/usageEnd le '@{pipeline().parameters.UsageEndDate}'"
                                    },
                                    "scope": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.scope"
                                    },
                                    "servicePrincipalId": {
                                        "type": "Expression",
                                        "value": "@activity('GetClientId').output.value"
                                    },
                                    "servicePrincipalSecretKeyName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                    },
                                    "tenantId": {
                                        "type": "Expression",
                                        "value": "@activity('GetTenantId').output.value"
                                    }
                                },
                                "referenceName": "ManagementAPIDataSet",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "CopyConsumptionAPIMarketPlaceData",
                        "outputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "formatSettings": {
                                    "filePattern": "arrayOfObjects",
                                    "type": "JsonWriteSettings"
                                },
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "type": "JsonSink"
                            },
                            "source": {
                                "httpRequestTimeout": "00:10:00",
                                "paginationRules": {
                                    "AbsoluteUrl": "$.nextLink"
                                },
                                "requestInterval": "00.00:00:00.010",
                                "requestMethod": "GET",
                                "type": "RestSource"
                            },
                            "translator": {
                                "collectionReference": "$['value']",
                                "mappings": [
                                    {
                                        "sink": {
                                            "path": "$['id']"
                                        },
                                        "source": {
                                            "path": "[['id']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "path": "$['name']"
                                        },
                                        "source": {
                                            "path": "[['name']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "path": "$['type']"
                                        },
                                        "source": {
                                            "path": "[['type']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "path": "$['tags']"
                                        },
                                        "source": {
                                            "path": "[['tags']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "path": "$['properties']"
                                        },
                                        "source": {
                                            "path": "[['properties']"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "description": "\n\nsubscriptions/b466d563-74e6-4232-a5c6-f39f65f6f1fc - No data returned\n",
                "folder": {
                    "name": "Marketplaces"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "ConsumptionAPIVersion": {
                        "defaultValue": "2019-10-01",
                        "type": "string"
                    },
                    "DownloadTargetFilename": {
                        "defaultValue": "marketplace.json",
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "defaultValue": "download/marketplace",
                        "type": "string"
                    },
                    "UsageEndDate": {
                        "defaultValue": "2021-09-21",
                        "type": "string"
                    },
                    "UsageStartDate": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "scope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/<BillingAccountNum>",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/ManagementAPIDataSet')]",
                "[concat(variables('factoryId'), '/datasets/JsonDataset')]"
            ],
            "name": "[concat(parameters('factoryName'), '/GetPriceSheet')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "inputs": [
                            {
                                "parameters": {
                                    "KeyVaultName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                    },
                                    "api": "providers/Microsoft.Consumption/pricesheets/default",
                                    "apiversion": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                    },
                                    "filter": {
                                        "type": "Expression",
                                        "value": "&$expand=meterDetails"
                                    },
                                    "scope": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.scope"
                                    },
                                    "servicePrincipalId": {
                                        "type": "Expression",
                                        "value": "@activity('GetClientId').output.value"
                                    },
                                    "servicePrincipalSecretKeyName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                    },
                                    "tenantId": {
                                        "type": "Expression",
                                        "value": "@activity('GetTenantId').output.value"
                                    }
                                },
                                "referenceName": "ManagementAPIDataSet",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "CopyConsumptionAPIPriceSheetData",
                        "outputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobContainer"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": true,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "formatSettings": {
                                    "filePattern": "arrayOfObjects",
                                    "type": "JsonWriteSettings"
                                },
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "type": "JsonSink"
                            },
                            "source": {
                                "httpRequestTimeout": "00:10:00",
                                "paginationRules": {
                                    "AbsoluteUrl": "$.properties.nextLink"
                                },
                                "requestInterval": "00.00:00:00.010",
                                "requestMethod": "GET",
                                "type": "RestSource"
                            },
                            "translator": {
                                "collectionReference": "$['properties']['pricesheets']",
                                "mappings": [
                                    {
                                        "sink": {
                                            "path": "$['billingPeriodId']"
                                        },
                                        "source": {
                                            "path": "[['billingPeriodId']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "path": "$['meterId']"
                                        },
                                        "source": {
                                            "path": "[['meterId']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "path": "$['meterDetails']"
                                        },
                                        "source": {
                                            "path": "[['meterDetails']"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "PriceSheet"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "ConsumptionAPIVersion": {
                        "defaultValue": "2019-10-01",
                        "type": "string"
                    },
                    "DownloadTargetFilename": {
                        "defaultValue": "pricesheet.json",
                        "type": "string"
                    },
                    "Download_StorageBlobContainer": {
                        "defaultValue": "aubi",
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "defaultValue": "download/pricesheet/",
                        "type": "string"
                    },
                    "scope": {
                        "defaultValue": "subscriptions/<SubId>",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/JsonDataset')]",
                "[concat(variables('factoryId'), '/datasets/ManagementAPIDataSet')]"
            ],
            "name": "[concat(parameters('factoryName'), '/GetRecommendationsForSub')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "TryUntilFileExists",
                        "type": "Until",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "GetAdvisorData",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "GetFileMetadata",
                                    "policy": {
                                        "retry": 0,
                                        "retryIntervalInSeconds": 30,
                                        "secureInput": false,
                                        "secureOutput": false,
                                        "timeout": "0.00:02:00"
                                    },
                                    "type": "GetMetadata",
                                    "typeProperties": {
                                        "dataset": {
                                            "parameters": {
                                                "Container": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_Container"
                                                },
                                                "Directory": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                                },
                                                "FileName": {
                                                    "type": "Expression",
                                                    "value": "advisor_@{pipeline().parameters.SubscriptionId}.json"
                                                },
                                                "StorageAccountName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                                }
                                            },
                                            "referenceName": "JsonDataset",
                                            "type": "DatasetReference"
                                        },
                                        "fieldList": [
                                            "exists"
                                        ],
                                        "formatSettings": {
                                            "type": "JsonReadSettings"
                                        },
                                        "storeSettings": {
                                            "recursive": true,
                                            "type": "AzureBlobStorageReadSettings"
                                        }
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [],
                                    "inputs": [
                                        {
                                            "parameters": {
                                                "KeyVaultName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                                },
                                                "api": {
                                                    "type": "Expression",
                                                    "value": "providers/Microsoft.Advisor/recommendations"
                                                },
                                                "apiversion": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().parameters.RecommendationsAPIVersion"
                                                },
                                                "filter": {
                                                    "type": "Expression",
                                                    "value": "@trim('')"
                                                },
                                                "scope": {
                                                    "type": "Expression",
                                                    "value": "subscriptions/@{pipeline().parameters.SubscriptionId}"
                                                },
                                                "servicePrincipalId": {
                                                    "type": "Expression",
                                                    "value": "@activity('GetClientId').output.value"
                                                },
                                                "servicePrincipalSecretKeyName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                                },
                                                "tenantId": {
                                                    "type": "Expression",
                                                    "value": "@activity('GetTenantId').output.value"
                                                }
                                            },
                                            "referenceName": "ManagementAPIDataSet",
                                            "type": "DatasetReference"
                                        }
                                    ],
                                    "name": "GetAdvisorData",
                                    "outputs": [
                                        {
                                            "parameters": {
                                                "Container": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_Container"
                                                },
                                                "Directory": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                                },
                                                "FileName": {
                                                    "type": "Expression",
                                                    "value": "advisor_@{pipeline().parameters.SubscriptionId}.json"
                                                },
                                                "StorageAccountName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                                }
                                            },
                                            "referenceName": "JsonDataset",
                                            "type": "DatasetReference"
                                        }
                                    ],
                                    "policy": {
                                        "retry": 0,
                                        "retryIntervalInSeconds": 30,
                                        "secureInput": false,
                                        "secureOutput": false,
                                        "timeout": "0.00:10:00"
                                    },
                                    "type": "Copy",
                                    "typeProperties": {
                                        "enableStaging": false,
                                        "sink": {
                                            "formatSettings": {
                                                "type": "JsonWriteSettings"
                                            },
                                            "storeSettings": {
                                                "type": "AzureBlobStorageWriteSettings"
                                            },
                                            "type": "JsonSink"
                                        },
                                        "source": {
                                            "httpRequestTimeout": "00:01:40",
                                            "requestInterval": "00.00:00:00.010",
                                            "requestMethod": "GET",
                                            "type": "RestSource"
                                        }
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "GetFileMetadata",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "WaitIfFileIsMissing",
                                    "type": "IfCondition",
                                    "typeProperties": {
                                        "expression": {
                                            "type": "Expression",
                                            "value": "@bool(activity('GetFileMetadata').output.exists)"
                                        },
                                        "ifFalseActivities": [
                                            {
                                                "dependsOn": [],
                                                "name": "Wait",
                                                "type": "Wait",
                                                "typeProperties": {
                                                    "waitTimeInSeconds": {
                                                        "type": "Expression",
                                                        "value": "@pipeline().parameters.WaitTimeSecs"
                                                    }
                                                },
                                                "userProperties": []
                                            }
                                        ]
                                    },
                                    "userProperties": []
                                }
                            ],
                            "expression": {
                                "type": "Expression",
                                "value": "@bool(activity('GetFileMetadata').output.exists)"
                            },
                            "timeout": "0.00:20:00"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "Advisor"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "DownloadTargetFilename": {
                        "type": "string"
                    },
                    "Download_StorageBlobContainer": {
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "type": "string"
                    },
                    "RecommendationsAPIVersion": {
                        "defaultValue": "2020-01-01",
                        "type": "string"
                    },
                    "SubscriptionId": {
                        "type": "string"
                    },
                    "WaitTimeSecs": {
                        "defaultValue": 60,
                        "type": "int"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/AubiBinaryFile')]",
                "[concat(variables('factoryId'), '/pipelines/GetReservationDetailsReportAsynch')]"
            ],
            "name": "[concat(parameters('factoryName'), '/GetReservationDetailsOrchestrator')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "name": "DeleteReservationDetailsFiles",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Delete",
                        "typeProperties": {
                            "dataset": {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.costopt_StorageDirectoryName"
                                    },
                                    "FIleName": "NOTNEEDED",
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "AubiBinaryFile",
                                "type": "DatasetReference"
                            },
                            "enableLogging": false,
                            "storeSettings": {
                                "enablePartitionDiscovery": false,
                                "recursive": false,
                                "type": "AzureBlobStorageReadSettings",
                                "wildcardFileName": "*"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "SetBatchStartDate",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "UntilEndDateReached",
                        "type": "Until",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "name": "SetBatchEndDate",
                                    "type": "SetVariable",
                                    "typeProperties": {
                                        "value": {
                                            "type": "Expression",
                                            "value": "@if( greater(adddays(variables('BatchStartDate'),pipeline().parameters.ResDetailsLoopIncrement,'yyyy-MM-dd') , pipeline().parameters.ExtractEndDate)\n, pipeline().parameters.ExtractEndDate\n,adddays(variables('BatchStartDate'),pipeline().parameters.ResDetailsLoopIncrement,'yyyy-MM-dd')\n)"
                                        },
                                        "variableName": "BatchEndDate"
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "AddDateRangeToProcess",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "SetNewStartDate",
                                    "type": "SetVariable",
                                    "typeProperties": {
                                        "value": {
                                            "type": "Expression",
                                            "value": "@adddays(variables('BatchEndDate'),1,'yyyy-MM-dd')"
                                        },
                                        "variableName": "BatchStartDate"
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "SetBatchEndDate",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "AddDateRangeToProcess",
                                    "type": "AppendVariable",
                                    "typeProperties": {
                                        "value": {
                                            "type": "Expression",
                                            "value": "{\"StartDate\":\"@{variables('BatchStartDate')}\",\"EndDate\":\"@{variables('BatchEndDate')}\"}"
                                        },
                                        "variableName": "DateRangesToProcess"
                                    },
                                    "userProperties": []
                                }
                            ],
                            "expression": {
                                "type": "Expression",
                                "value": "@greaterOrEquals(variables('BatchEndDate'),pipeline().parameters.ExtractEndDate)"
                            },
                            "timeout": "7.00:00:00"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "DeleteReservationDetailsFiles",
                                "dependencyConditions": [
                                    "Completed"
                                ]
                            }
                        ],
                        "name": "SetBatchStartDate",
                        "type": "SetVariable",
                        "typeProperties": {
                            "value": {
                                "type": "Expression",
                                "value": "@pipeline().parameters.ExtractStartDate"
                            },
                            "variableName": "BatchStartDate"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "UntilEndDateReached",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "ForEachDateRange",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "name": "GetReservationDetails",
                                    "type": "ExecutePipeline",
                                    "typeProperties": {
                                        "parameters": {
                                            "CostManagementAPIVersion": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.CostManagementAPIVersion"
                                            },
                                            "DownloadTargetFilename": {
                                                "type": "Expression",
                                                "value": "resdetails-@{formatDateTime(json(item()).StartDate,'yyyyMMdd')}-@{formatDateTime(json(item()).EndDate,'yyyyMMdd')}.csv"
                                            },
                                            "Download_StorageBlobDirectory": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.costopt_StorageDirectoryName"
                                            },
                                            "EndDate": {
                                                "type": "Expression",
                                                "value": "@json(item()).EndDate"
                                            },
                                            "StartDate": {
                                                "type": "Expression",
                                                "value": "@json(item()).StartDate"
                                            },
                                            "scope": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.BillingAccountScope"
                                            }
                                        },
                                        "pipeline": {
                                            "referenceName": "GetReservationDetailsReportAsynch",
                                            "type": "PipelineReference"
                                        },
                                        "waitOnCompletion": true
                                    },
                                    "userProperties": []
                                }
                            ],
                            "batchCount": 5,
                            "isSequential": false,
                            "items": {
                                "type": "Expression",
                                "value": "@variables('DateRangesToProcess')"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "ReservationDetails"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "BillingAccountScope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/<BillingAccountNum>",
                        "type": "string"
                    },
                    "CostManagementAPIVersion": {
                        "defaultValue": "2019-11-01",
                        "type": "string"
                    },
                    "ExtractEndDate": {
                        "defaultValue": "2021-01-03",
                        "type": "string"
                    },
                    "ExtractStartDate": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "ResDetailsLoopIncrement": {
                        "defaultValue": 60,
                        "type": "int"
                    },
                    "costopt_StorageDirectoryName": {
                        "defaultValue": "download/resdetails",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                },
                "variables": {
                    "BatchEndDate": {
                        "type": "String"
                    },
                    "BatchStartDate": {
                        "type": "String"
                    },
                    "DateRangesToProcess": {
                        "type": "Array"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/HTTPFile')]",
                "[concat(variables('factoryId'), '/datasets/AubiBinaryFile')]",
                "[concat(variables('factoryId'), '/linkedServices/aubiKeyVault')]"
            ],
            "name": "[concat(parameters('factoryName'), '/GetReservationDetailsReportAsynch')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "PostReservationDetailsReportRequestAsynch",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "password": {
                                    "secretName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                    },
                                    "store": {
                                        "parameters": {
                                            "KeyVaultName": {
                                                "type": "Expression",
                                                "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                            }
                                        },
                                        "referenceName": "aubiKeyVault",
                                        "type": "LinkedServiceReference"
                                    },
                                    "type": "AzureKeyVaultSecret"
                                },
                                "resource": {
                                    "type": "Expression",
                                    "value": "https://management.azure.com/"
                                },
                                "type": "ServicePrincipal",
                                "userTenant": {
                                    "type": "Expression",
                                    "value": "@{activity('GetTenantId').output.value}"
                                },
                                "username": {
                                    "type": "Expression",
                                    "value": "@{activity('GetClientId').output.value}"
                                }
                            },
                            "body": "x",
                            "headers": {},
                            "method": "POST",
                            "url": {
                                "type": "Expression",
                                "value": "https://management.azure.com/@{pipeline().parameters.scope}/providers/Microsoft.CostManagement/generateReservationDetailsReport?api-version=@{pipeline().parameters.CostManagementAPIVersion}&startDate=@{pipeline().parameters.StartDate}&endDate=@{pipeline().parameters.EndDate}"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "PostReservationDetailsReportRequestAsynch",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "inputs": [
                            {
                                "parameters": {
                                    "FileURL": {
                                        "type": "Expression",
                                        "value": "@activity('PostReservationDetailsReportRequestAsynch').output.properties.reportUrl"
                                    }
                                },
                                "referenceName": "HTTPFile",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "DownloadResTransReport",
                        "outputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                    },
                                    "FIleName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "AubiBinaryFile",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "type": "BinarySink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                },
                                "storeSettings": {
                                    "requestMethod": "GET",
                                    "type": "HttpReadSettings"
                                },
                                "type": "BinarySource"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "ReservationDetails"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "CostManagementAPIVersion": {
                        "defaultValue": "2019-11-01",
                        "type": "string"
                    },
                    "DownloadTargetFilename": {
                        "defaultValue": "resdetails.csv",
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "defaultValue": "download/resdetails",
                        "type": "string"
                    },
                    "EndDate": {
                        "defaultValue": "2021-08-31",
                        "type": "string"
                    },
                    "StartDate": {
                        "defaultValue": "2021-08-01",
                        "type": "string"
                    },
                    "scope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/<BillingAccountNum>",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                },
                "variables": {
                    "ReservationDetailsReportLocation": {
                        "type": "String"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/ManagementAPIDataSet')]",
                "[concat(variables('factoryId'), '/datasets/JsonDataset')]"
            ],
            "name": "[concat(parameters('factoryName'), '/GetReservationRecommendations')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "ForEachService - Single",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "inputs": [
                                        {
                                            "parameters": {
                                                "KeyVaultName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                                },
                                                "api": "providers/Microsoft.Consumption/reservationRecommendations",
                                                "apiversion": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                                },
                                                "filter": {
                                                    "type": "Expression",
                                                    "value": "&$filter=properties/scope eq 'Single' AND properties/lookBackPeriod eq '@{pipeline().parameters.LookbackPeriod}' AND properties/resourceType eq '@{item()}'"
                                                },
                                                "scope": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().parameters.scope"
                                                },
                                                "servicePrincipalId": {
                                                    "type": "Expression",
                                                    "value": "@activity('GetClientId').output.value"
                                                },
                                                "servicePrincipalSecretKeyName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                                },
                                                "tenantId": {
                                                    "type": "Expression",
                                                    "value": "@activity('GetTenantId').output.value"
                                                }
                                            },
                                            "referenceName": "ManagementAPIDataSet",
                                            "type": "DatasetReference"
                                        }
                                    ],
                                    "name": "CopyReservationRecommendationsSingle",
                                    "outputs": [
                                        {
                                            "parameters": {
                                                "Container": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_Container"
                                                },
                                                "Directory": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                                },
                                                "FileName": {
                                                    "type": "Expression",
                                                    "value": "@{concat(pipeline().parameters.Single_RI_FilenamePrefix,item(),'.json')}"
                                                },
                                                "StorageAccountName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                                }
                                            },
                                            "referenceName": "JsonDataset",
                                            "type": "DatasetReference"
                                        }
                                    ],
                                    "policy": {
                                        "retry": 0,
                                        "retryIntervalInSeconds": 30,
                                        "secureInput": false,
                                        "secureOutput": false,
                                        "timeout": "7.00:00:00"
                                    },
                                    "type": "Copy",
                                    "typeProperties": {
                                        "enableStaging": false,
                                        "sink": {
                                            "formatSettings": {
                                                "type": "JsonWriteSettings"
                                            },
                                            "storeSettings": {
                                                "type": "AzureBlobStorageWriteSettings"
                                            },
                                            "type": "JsonSink"
                                        },
                                        "source": {
                                            "httpRequestTimeout": "00:01:40",
                                            "paginationRules": {
                                                "AbsoluteUrl": "$.nextLink"
                                            },
                                            "requestInterval": "00.00:00:00.010",
                                            "requestMethod": "GET",
                                            "type": "RestSource"
                                        },
                                        "translator": {
                                            "collectionReference": "$['value']",
                                            "mappings": [
                                                {
                                                    "sink": {
                                                        "path": "$['kind']"
                                                    },
                                                    "source": {
                                                        "path": "[['kind']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['id']"
                                                    },
                                                    "source": {
                                                        "path": "[['id']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['name']"
                                                    },
                                                    "source": {
                                                        "path": "[['name']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['type']"
                                                    },
                                                    "source": {
                                                        "path": "[['type']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['location']"
                                                    },
                                                    "source": {
                                                        "path": "[['location']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['sku']"
                                                    },
                                                    "source": {
                                                        "path": "[['sku']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['properties']"
                                                    },
                                                    "source": {
                                                        "path": "[['properties']"
                                                    }
                                                }
                                            ],
                                            "type": "TabularTranslator"
                                        }
                                    },
                                    "userProperties": []
                                }
                            ],
                            "items": {
                                "type": "Expression",
                                "value": "@pipeline().globalParameters.ResRecServicesArray"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "ForEachService - Shared",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "inputs": [
                                        {
                                            "parameters": {
                                                "KeyVaultName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                                },
                                                "api": "providers/Microsoft.Consumption/reservationRecommendations",
                                                "apiversion": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                                },
                                                "filter": {
                                                    "type": "Expression",
                                                    "value": "&$filter=properties/scope eq 'Shared' AND properties/lookBackPeriod eq '@{pipeline().parameters.LookbackPeriod}' AND properties/resourceType eq '@{item()}'"
                                                },
                                                "scope": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().parameters.scope"
                                                },
                                                "servicePrincipalId": {
                                                    "type": "Expression",
                                                    "value": "@activity('GetClientId').output.value"
                                                },
                                                "servicePrincipalSecretKeyName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                                },
                                                "tenantId": {
                                                    "type": "Expression",
                                                    "value": "@activity('GetTenantId').output.value"
                                                }
                                            },
                                            "referenceName": "ManagementAPIDataSet",
                                            "type": "DatasetReference"
                                        }
                                    ],
                                    "name": "CopyReservationRecommendationsShared",
                                    "outputs": [
                                        {
                                            "parameters": {
                                                "Container": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_Container"
                                                },
                                                "Directory": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                                },
                                                "FileName": {
                                                    "type": "Expression",
                                                    "value": "@{concat(pipeline().parameters.Shared_RI_FilenamePrefix,item(),'.json')}"
                                                },
                                                "StorageAccountName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                                }
                                            },
                                            "referenceName": "JsonDataset",
                                            "type": "DatasetReference"
                                        }
                                    ],
                                    "policy": {
                                        "retry": 0,
                                        "retryIntervalInSeconds": 30,
                                        "secureInput": false,
                                        "secureOutput": false,
                                        "timeout": "7.00:00:00"
                                    },
                                    "type": "Copy",
                                    "typeProperties": {
                                        "enableStaging": false,
                                        "sink": {
                                            "formatSettings": {
                                                "type": "JsonWriteSettings"
                                            },
                                            "storeSettings": {
                                                "type": "AzureBlobStorageWriteSettings"
                                            },
                                            "type": "JsonSink"
                                        },
                                        "source": {
                                            "httpRequestTimeout": "00:01:40",
                                            "paginationRules": {
                                                "AbsoluteUrl": "$.nextLink"
                                            },
                                            "requestInterval": "00.00:00:00.010",
                                            "requestMethod": "GET",
                                            "type": "RestSource"
                                        },
                                        "translator": {
                                            "collectionReference": "$['value']",
                                            "mappings": [
                                                {
                                                    "sink": {
                                                        "path": "$['kind']"
                                                    },
                                                    "source": {
                                                        "path": "[['kind']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['id']"
                                                    },
                                                    "source": {
                                                        "path": "[['id']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['name']"
                                                    },
                                                    "source": {
                                                        "path": "[['name']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['type']"
                                                    },
                                                    "source": {
                                                        "path": "[['type']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['location']"
                                                    },
                                                    "source": {
                                                        "path": "[['location']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['sku']"
                                                    },
                                                    "source": {
                                                        "path": "[['sku']"
                                                    }
                                                },
                                                {
                                                    "sink": {
                                                        "path": "$['properties']"
                                                    },
                                                    "source": {
                                                        "path": "[['properties']"
                                                    }
                                                }
                                            ],
                                            "type": "TabularTranslator"
                                        }
                                    },
                                    "userProperties": []
                                }
                            ],
                            "items": {
                                "type": "Expression",
                                "value": "@pipeline().globalParameters.ResRecServicesArray"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "ReservationRecommendations"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "ConsumptionAPIVersion": {
                        "defaultValue": "2021-10-01",
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "defaultValue": "download/resrecommendations",
                        "type": "string"
                    },
                    "LookbackPeriod": {
                        "defaultValue": "Last7Days",
                        "type": "string"
                    },
                    "Shared_RI_FilenamePrefix": {
                        "defaultValue": "Shared_",
                        "type": "string"
                    },
                    "Single_RI_FilenamePrefix": {
                        "defaultValue": "Single_",
                        "type": "string"
                    },
                    "scope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/<BillingAccountNum>",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/RIRecommendationsJson')]",
                "[concat(variables('factoryId'), '/datasets/JsonDataset')]",
                "[concat(variables('factoryId'), '/datasets/AubiBinaryFile')]",
                "[concat(variables('factoryId'), '/pipelines/GetReservationRecommendations')]"
            ],
            "name": "[concat(parameters('factoryName'), '/GetReservationRecommendationsOrchestrator')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [
                            {
                                "activity": "DeleteTargetFile",
                                "dependencyConditions": [
                                    "Completed"
                                ]
                            }
                        ],
                        "name": "ForEachLookbackPeriod",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "name": "GetReservationRecommendations",
                                    "type": "ExecutePipeline",
                                    "typeProperties": {
                                        "parameters": {
                                            "ConsumptionAPIVersion": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                            },
                                            "Download_StorageBlobDirectory": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                            },
                                            "LookbackPeriod": {
                                                "type": "Expression",
                                                "value": "@item()"
                                            },
                                            "Shared_RI_FilenamePrefix": {
                                                "type": "Expression",
                                                "value": "@concat(pipeline().parameters.Shared_RI_FilenamePrefix,item())"
                                            },
                                            "Single_RI_FilenamePrefix": {
                                                "type": "Expression",
                                                "value": "@concat(pipeline().parameters.Single_RI_FilenamePrefix,item())"
                                            },
                                            "scope": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.scope"
                                            }
                                        },
                                        "pipeline": {
                                            "referenceName": "GetReservationRecommendations",
                                            "type": "PipelineReference"
                                        },
                                        "waitOnCompletion": true
                                    },
                                    "userProperties": []
                                }
                            ],
                            "isSequential": false,
                            "items": {
                                "type": "Expression",
                                "value": "@pipeline().globalParameters.ResRecLookbackPeriodsArray"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ForEachLookbackPeriod",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "RIRecommendationsJson",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "MergeRIRecommendations",
                        "outputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.Download_StorageBlobDirectory}/merged"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "formatSettings": {
                                    "filePattern": "arrayOfObjects",
                                    "type": "JsonWriteSettings"
                                },
                                "storeSettings": {
                                    "copyBehavior": "MergeFiles",
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "type": "JsonSink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "JsonReadSettings"
                                },
                                "storeSettings": {
                                    "enablePartitionDiscovery": false,
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings",
                                    "wildcardFileName": "*",
                                    "wildcardFolderPath": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                    }
                                },
                                "type": "JsonSource"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "DeleteTargetFile",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "0.00:01:00"
                        },
                        "type": "Delete",
                        "typeProperties": {
                            "dataset": {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.Download_StorageBlobDirectory}/merged"
                                    },
                                    "FIleName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "AubiBinaryFile",
                                "type": "DatasetReference"
                            },
                            "enableLogging": false,
                            "storeSettings": {
                                "enablePartitionDiscovery": false,
                                "recursive": false,
                                "type": "AzureBlobStorageReadSettings"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "description": "Gets Shared and Single RI Recommendations for multiple lookback periods (parameter) for multiple services (parameter) and merge these into a single file. \nOne \"Shared Recommendations\" file and one \"Single Recommendations\" file is created.",
                "folder": {
                    "name": "ReservationRecommendations"
                },
                "lastPublishTime": "2022-10-22T21:36:25Z",
                "parameters": {
                    "ConsumptionAPIVersion": {
                        "defaultValue": "2021-10-01",
                        "type": "string"
                    },
                    "DownloadTargetFilename": {
                        "defaultValue": "reservation_recs_merged.json",
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "defaultValue": "download/resrecommendations",
                        "type": "string"
                    },
                    "Shared_RI_FilenamePrefix": {
                        "defaultValue": "Shared_RI_Recommendation",
                        "type": "string"
                    },
                    "Single_RI_FilenamePrefix": {
                        "defaultValue": "Single_RI_Recommendation",
                        "type": "string"
                    },
                    "scope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/<BillingAccountNum>",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/ManagementAPIDataSet')]",
                "[concat(variables('factoryId'), '/datasets/JsonDataset')]"
            ],
            "name": "[concat(parameters('factoryName'), '/GetReservationTransactions')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "inputs": [
                            {
                                "parameters": {
                                    "KeyVaultName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                    },
                                    "api": "providers/Microsoft.Consumption/reservationTransactions",
                                    "apiversion": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                    },
                                    "filter": {
                                        "type": "Expression",
                                        "value": "&$filter=properties/EventDate ge @{pipeline().parameters.EventStartDate} AND properties/EventDate le @{pipeline().parameters.EventEndDate}"
                                    },
                                    "scope": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.scope"
                                    },
                                    "servicePrincipalId": {
                                        "type": "Expression",
                                        "value": "@activity('GetClientId').output.value"
                                    },
                                    "servicePrincipalSecretKeyName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                    },
                                    "tenantId": {
                                        "type": "Expression",
                                        "value": "@activity('GetTenantId').output.value"
                                    }
                                },
                                "referenceName": "ManagementAPIDataSet",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "CopyConsumptionAPIReservationTransactionsData",
                        "outputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": true,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "formatSettings": {
                                    "filePattern": "arrayOfObjects",
                                    "type": "JsonWriteSettings"
                                },
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "type": "JsonSink"
                            },
                            "source": {
                                "httpRequestTimeout": "00:10:00",
                                "paginationRules": {
                                    "AbsoluteUrl": "$.nextLink"
                                },
                                "requestInterval": "00.00:00:00.010",
                                "requestMethod": "GET",
                                "type": "RestSource"
                            },
                            "translator": {
                                "collectionReference": "$['value']",
                                "mappings": [
                                    {
                                        "sink": {
                                            "path": "$['id']"
                                        },
                                        "source": {
                                            "path": "[['id']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "path": "$['name']"
                                        },
                                        "source": {
                                            "path": "[['name']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "path": "$['type']"
                                        },
                                        "source": {
                                            "path": "[['type']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "path": "$['tags']"
                                        },
                                        "source": {
                                            "path": "[['tags']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "path": "$['properties']"
                                        },
                                        "source": {
                                            "path": "[['properties']"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "ReservationTransactions"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "ConsumptionAPIVersion": {
                        "defaultValue": "2019-10-01",
                        "type": "string"
                    },
                    "DownloadTargetFilename": {
                        "defaultValue": "restransactions.json",
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "defaultValue": "download/restransactions",
                        "type": "string"
                    },
                    "EventEndDate": {
                        "defaultValue": "2021-08-31",
                        "type": "string"
                    },
                    "EventStartDate": {
                        "defaultValue": "2021-08-01",
                        "type": "string"
                    },
                    "scope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/<BillingAccountNum>",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/HTTPFile')]"
            ],
            "name": "[concat(parameters('factoryName'), '/HTTPFile')]",
            "properties": {
                "annotations": [],
                "linkedServiceName": {
                    "parameters": {
                        "FileURL": {
                            "type": "Expression",
                            "value": "@dataset().FileURL"
                        }
                    },
                    "referenceName": "HTTPFile",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "FileURL": {
                        "type": "string"
                    }
                },
                "type": "Binary",
                "typeProperties": {
                    "location": {
                        "type": "HttpServerLocation"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/datasets"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [],
            "name": "[concat(parameters('factoryName'), '/HTTPFile')]",
            "properties": {
                "annotations": [],
                "description": "Linked Service for a HTTP location where authentication is not needed or is supplied in the URL",
                "parameters": {
                    "FileURL": {
                        "type": "string"
                    }
                },
                "type": "HttpServer",
                "typeProperties": {
                    "authenticationType": "Anonymous",
                    "enableServerCertificateValidation": true,
                    "url": "[parameters('HTTPFile_properties_typeProperties_url')]"
                }
            },
            "type": "Microsoft.DataFactory/factories/linkedServices"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/aubiAzureStorage')]"
            ],
            "name": "[concat(parameters('factoryName'), '/JsonDataset')]",
            "properties": {
                "annotations": [],
                "linkedServiceName": {
                    "parameters": {
                        "StorageAccountName": {
                            "type": "Expression",
                            "value": "@dataset().StorageAccountName"
                        }
                    },
                    "referenceName": "aubiAzureStorage",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "Container": {
                        "type": "string"
                    },
                    "Directory": {
                        "type": "string"
                    },
                    "FileName": {
                        "type": "string"
                    },
                    "StorageAccountName": {
                        "type": "string"
                    }
                },
                "schema": {},
                "type": "Json",
                "typeProperties": {
                    "location": {
                        "container": {
                            "type": "Expression",
                            "value": "@dataset().Container"
                        },
                        "fileName": {
                            "type": "Expression",
                            "value": "@dataset().FileName"
                        },
                        "folderPath": {
                            "type": "Expression",
                            "value": "@dataset().Directory"
                        },
                        "type": "AzureBlobStorageLocation"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/datasets"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/aubiKeyVault')]"
            ],
            "name": "[concat(parameters('factoryName'), '/ListExports')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "ListExports",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "password": {
                                    "secretName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                    },
                                    "store": {
                                        "parameters": {
                                            "KeyVaultName": {
                                                "type": "Expression",
                                                "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                            }
                                        },
                                        "referenceName": "aubiKeyVault",
                                        "type": "LinkedServiceReference"
                                    },
                                    "type": "AzureKeyVaultSecret"
                                },
                                "resource": "https://management.azure.com",
                                "type": "ServicePrincipal",
                                "userTenant": {
                                    "type": "Expression",
                                    "value": "@activity('GetTenantId').output.value"
                                },
                                "username": {
                                    "type": "Expression",
                                    "value": "@activity('GetClientId').output.value"
                                }
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://management.azure.com/@{pipeline().parameters.scope}/providers/Microsoft.CostManagement/exports?api-version=@{pipeline().parameters.CostManagementAPIVersion}"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "UsageData"
                },
                "lastPublishTime": "2022-10-22T21:36:23Z",
                "parameters": {
                    "CostManagementAPIVersion": {
                        "defaultValue": "2020-06-01",
                        "type": "string"
                    },
                    "scope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/<BillingAccountNum>",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/CSVFileDataset')]",
                "[concat(variables('factoryId'), '/datasets/costoptSQLTableDataset')]"
            ],
            "name": "[concat(parameters('factoryName'), '/LoadConsumptionDataToDatabase')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [
                            {
                                "activity": "Set SQL Delete Statement",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@trim('')"
                                    },
                                    "File": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.UsageDownload_Filename"
                                    },
                                    "StorageAccount": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "CSVFileDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "LoadToSQL",
                        "outputs": [
                            {
                                "parameters": {
                                    "schemaname": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.TargetSchemaName"
                                    },
                                    "sqldbname": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqldbname"
                                    },
                                    "sqlservername": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqlservername"
                                    },
                                    "tablename": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.TargetTableName"
                                    }
                                },
                                "referenceName": "costoptSQLTableDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "0.02:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "disableMetricsCollection": false,
                                "preCopyScript": {
                                    "type": "Expression",
                                    "value": "@{variables('sqldelete')}"
                                },
                                "type": "AzureSqlSink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "DelimitedTextReadSettings"
                                },
                                "storeSettings": {
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings"
                                },
                                "type": "DelimitedTextSource"
                            },
                            "translator": {
                                "mappings": [
                                    {
                                        "sink": {
                                            "name": "InvoiceSectionName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "InvoiceSectionName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AccountName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AccountName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AccountOwnerId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AccountOwnerId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "SubscriptionId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "SubscriptionId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "SubscriptionName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "SubscriptionName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceGroup",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceGroup",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceLocation",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceLocation",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Date",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "name": "Date",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ProductName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ProductName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterCategory",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterCategory",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterSubCategory",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterSubCategory",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterRegion",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterRegion",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "UnitOfMeasure",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "UnitOfMeasure",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Quantity",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "Quantity",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "EffectivePrice",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "EffectivePrice",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "CostInBillingCurrency",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "CostInBillingCurrency",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "CostCenter",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "CostCenter",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ConsumedService",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ConsumedService",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Tags",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "Tags",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "OfferId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "OfferId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AdditionalInfo",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AdditionalInfo",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ServiceInfo1",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ServiceInfo1",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ServiceInfo2",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ServiceInfo2",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ReservationId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ReservationId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ReservationName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ReservationName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "UnitPrice",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "UnitPrice",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ProductOrderId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ProductOrderId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ProductOrderName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ProductOrderName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Term",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "Term",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PublisherType",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PublisherType",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PublisherName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PublisherName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ChargeType",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ChargeType",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Frequency",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "Frequency",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PricingModel",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PricingModel",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AvailabilityZone",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AvailabilityZone",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingAccountId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingAccountId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingAccountName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingAccountName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingCurrencyCode",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingCurrencyCode",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingPeriodStartDate",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "name": "BillingPeriodStartDate",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingPeriodEndDate",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "name": "BillingPeriodEndDate",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingProfileId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingProfileId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingProfileName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingProfileName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "InvoiceSectionId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "InvoiceSectionId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "IsAzureCreditEligible",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "IsAzureCreditEligible",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PartNumber",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PartNumber",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PayGPrice",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PayGPrice",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PlanName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PlanName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ServiceFamily",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ServiceFamily",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "CostAllocationRuleName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "CostAllocationRuleName",
                                            "type": "String"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "Set SQL Delete Statement",
                        "type": "SetVariable",
                        "typeProperties": {
                            "value": {
                                "type": "Expression",
                                "value": "DELETE @{pipeline().parameters.TargetSchemaName}.@{pipeline().parameters.TargetTableName} WHERE [Date] BETWEEN '@{pipeline().parameters.StartDate}' AND '@{pipeline().parameters.EndDate}'"
                            },
                            "variableName": "sqldelete"
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "concurrency": 1,
                "folder": {
                    "name": "UsageData"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "EndDate": {
                        "type": "string"
                    },
                    "StartDate": {
                        "type": "string"
                    },
                    "TargetSchemaName": {
                        "type": "string"
                    },
                    "TargetTableName": {
                        "type": "string"
                    },
                    "UsageDownload_Filename": {
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                },
                "variables": {
                    "sqldelete": {
                        "type": "String"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/CSVFileDataset')]",
                "[concat(variables('factoryId'), '/datasets/costoptSQLTableDataset')]"
            ],
            "name": "[concat(parameters('factoryName'), '/LoadISFRatioToSQL')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                    },
                                    "File": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccount": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "CSVFileDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "CopyIFSRatioToSQL",
                        "outputs": [
                            {
                                "parameters": {
                                    "schemaname": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.TargetDBSchema"
                                    },
                                    "sqldbname": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqldbname"
                                    },
                                    "sqlservername": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqlservername"
                                    },
                                    "tablename": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.TargetDBTable"
                                    }
                                },
                                "referenceName": "costoptSQLTableDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "disableMetricsCollection": false,
                                "preCopyScript": {
                                    "type": "Expression",
                                    "value": "delete @{pipeline().parameters.TargetDBSchema}.@{pipeline().parameters.TargetDBTable}"
                                },
                                "type": "AzureSqlSink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "DelimitedTextReadSettings"
                                },
                                "storeSettings": {
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings"
                                },
                                "type": "DelimitedTextSource"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "ISFRatio"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "DownloadTargetFilename": {
                        "defaultValue": "isfratio.csv",
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "defaultValue": "download/isfratio",
                        "type": "string"
                    },
                    "TargetDBSchema": {
                        "defaultValue": "costmanagement",
                        "type": "string"
                    },
                    "TargetDBTable": {
                        "defaultValue": "ISFData",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/JsonDataset')]",
                "[concat(variables('factoryId'), '/datasets/costoptSQLTableDataset')]"
            ],
            "name": "[concat(parameters('factoryName'), '/LoadPriceSheetToSQL')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.Download_StorageBlobDirectory"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.DownloadTargetFilename"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "CopyPriceSheetToSQL",
                        "outputs": [
                            {
                                "parameters": {
                                    "schemaname": "aubi",
                                    "sqldbname": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqldbname"
                                    },
                                    "sqlservername": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqlservername"
                                    },
                                    "tablename": "pricesheet"
                                },
                                "referenceName": "costoptSQLTableDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "disableMetricsCollection": false,
                                "preCopyScript": "delete aubi.pricesheet",
                                "type": "AzureSqlSink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "JsonReadSettings"
                                },
                                "storeSettings": {
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings"
                                },
                                "type": "JsonSource"
                            },
                            "translator": {
                                "collectionReference": "",
                                "mappings": [
                                    {
                                        "sink": {
                                            "name": "offerId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['offerId']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "id",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['id']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "billingPeriodId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['billingPeriodId']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "meterId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['meterId']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "meterName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['meterName']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "unitOfMeasure",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['unitOfMeasure']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "includedQuantity",
                                            "type": "Double"
                                        },
                                        "source": {
                                            "path": "$['includedQuantity']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "partNumber",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['partNumber']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "unitPrice",
                                            "type": "Double"
                                        },
                                        "source": {
                                            "path": "$['unitPrice']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "currencyCode",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['currencyCode']"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "PriceSheet"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "DownloadTargetFilename": {
                        "defaultValue": "pricesheet.json",
                        "type": "string"
                    },
                    "Download_StorageBlobDirectory": {
                        "defaultValue": "download/pricesheet",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/CSVFileDataset')]",
                "[concat(variables('factoryId'), '/datasets/costoptSQLTableDataset')]",
                "[concat(variables('factoryId'), '/linkedServices/AubiSQLDatabase')]"
            ],
            "name": "[concat(parameters('factoryName'), '/LoadResDetailsToDatabase')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.costopt_StorageDirectoryName"
                                    },
                                    "File": "NOTUSED",
                                    "StorageAccount": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "CSVFileDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "RefreshReservationDetailsSQLTable",
                        "outputs": [
                            {
                                "parameters": {
                                    "schemaname": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.ResDetailsTargetSchema"
                                    },
                                    "sqldbname": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqldbname"
                                    },
                                    "sqlservername": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqlservername"
                                    },
                                    "tablename": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.ResDetailsTargetTable"
                                    }
                                },
                                "referenceName": "costoptSQLTableDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "disableMetricsCollection": false,
                                "preCopyScript": "delete costmanagement.ReservationDetails",
                                "type": "AzureSqlSink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "DelimitedTextReadSettings"
                                },
                                "storeSettings": {
                                    "enablePartitionDiscovery": false,
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings",
                                    "wildcardFileName": "*",
                                    "wildcardFolderPath": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.costopt_StorageDirectoryName"
                                    }
                                },
                                "type": "DelimitedTextSource"
                            },
                            "translator": {
                                "mappings": [
                                    {
                                        "sink": {
                                            "name": "InstanceFlexibilityGroup",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "InstanceFlexibilityGroup",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "InstanceFlexibilityRatio",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "InstanceFlexibilityRatio",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "InstanceId",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "InstanceId",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Kind",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "Kind",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ReservationId",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ReservationId",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ReservationOrderId",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ReservationOrderId",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ReservedHours",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ReservedHours",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "SkuName",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "SkuName",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "TotalReservedQuantity",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "TotalReservedQuantity",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "UsageDate",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "UsageDate",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "UsedHours",
                                            "physicalType": "String",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "UsedHours",
                                            "physicalType": "String",
                                            "type": "String"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator",
                                "typeConversion": true,
                                "typeConversionSettings": {
                                    "allowDataTruncation": false,
                                    "treatBooleanAsNumber": false
                                }
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "RefreshReservationDetailsSQLTable",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "ReOrganizeIndex",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "[[costmanagement].[ReorganiseReservationDetailsIndex]"
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "ReservationDetails"
                },
                "lastPublishTime": "2022-10-22T21:36:24Z",
                "parameters": {
                    "ResDetailsTargetSchema": {
                        "defaultValue": "costmanagement",
                        "type": "string"
                    },
                    "ResDetailsTargetTable": {
                        "defaultValue": "ReservationDetails",
                        "type": "string"
                    },
                    "costopt_StorageDirectoryName": {
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/AzureManagementAPI')]"
            ],
            "name": "[concat(parameters('factoryName'), '/ManagementAPIDataSet')]",
            "properties": {
                "annotations": [],
                "linkedServiceName": {
                    "parameters": {
                        "KeyVaultName": {
                            "type": "Expression",
                            "value": "@dataset().KeyVaultName"
                        },
                        "servicePrincipalId": {
                            "type": "Expression",
                            "value": "@dataset().servicePrincipalId"
                        },
                        "servicePrincipalSecretKeyName": {
                            "type": "Expression",
                            "value": "@dataset().servicePrincipalSecretKeyName"
                        },
                        "tenantId": {
                            "type": "Expression",
                            "value": "@dataset().tenantId"
                        }
                    },
                    "referenceName": "AzureManagementAPI",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "KeyVaultName": {
                        "type": "string"
                    },
                    "api": {
                        "type": "string"
                    },
                    "apiversion": {
                        "type": "string"
                    },
                    "filter": {
                        "type": "string"
                    },
                    "scope": {
                        "type": "string"
                    },
                    "servicePrincipalId": {
                        "type": "string"
                    },
                    "servicePrincipalSecretKeyName": {
                        "type": "string"
                    },
                    "tenantId": {
                        "type": "string"
                    }
                },
                "schema": [],
                "type": "RestResource",
                "typeProperties": {
                    "relativeUrl": {
                        "type": "Expression",
                        "value": "@{dataset().scope}/@{dataset().api}?api-version=@{dataset().apiversion}@{dataset().filter}"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/datasets"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/CSVFileDataset')]",
                "[concat(variables('factoryId'), '/datasets/costoptSQLTableDataset')]",
                "[concat(variables('factoryId'), '/linkedServices/AubiSQLDatabase')]",
                "[concat(variables('factoryId'), '/datasets/Binary1')]"
            ],
            "name": "[concat(parameters('factoryName'), '/ProcessInboundUsageData')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [
                            {
                                "activity": "ForEachActualCostChildItem",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{pipeline().parameters.ActualCostExportName}"
                                    },
                                    "File": {
                                        "type": "Expression",
                                        "value": "NOTUSED"
                                    },
                                    "StorageAccount": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "CSVFileDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "LoadActualCostToSQL",
                        "outputs": [
                            {
                                "parameters": {
                                    "schemaname": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.TargetSchemaName"
                                    },
                                    "sqldbname": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqldbname"
                                    },
                                    "sqlservername": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqlservername"
                                    },
                                    "tablename": {
                                        "type": "Expression",
                                        "value": "ActualCost"
                                    }
                                },
                                "referenceName": "costoptSQLTableDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "0.02:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "disableMetricsCollection": false,
                                "type": "AzureSqlSink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "DelimitedTextReadSettings"
                                },
                                "storeSettings": {
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings",
                                    "wildcardFileName": "*.csv",
                                    "wildcardFolderPath": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{pipeline().parameters.ActualCostExportName}"
                                    }
                                },
                                "type": "DelimitedTextSource"
                            },
                            "translator": {
                                "mappings": [
                                    {
                                        "sink": {
                                            "name": "InvoiceSectionName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "InvoiceSectionName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AccountName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AccountName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AccountOwnerId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AccountOwnerId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "SubscriptionId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "SubscriptionId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "SubscriptionName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "SubscriptionName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceGroup",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceGroup",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceLocation",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceLocation",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Date",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "name": "Date",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ProductName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ProductName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterCategory",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterCategory",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterSubCategory",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterSubCategory",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterRegion",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterRegion",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "UnitOfMeasure",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "UnitOfMeasure",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Quantity",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "Quantity",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "EffectivePrice",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "EffectivePrice",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "CostInBillingCurrency",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "CostInBillingCurrency",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "CostCenter",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "CostCenter",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ConsumedService",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ConsumedService",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Tags",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "Tags",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "OfferId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "OfferId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AdditionalInfo",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AdditionalInfo",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ServiceInfo1",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ServiceInfo1",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ServiceInfo2",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ServiceInfo2",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ReservationId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ReservationId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ReservationName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ReservationName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "UnitPrice",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "UnitPrice",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ProductOrderId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ProductOrderId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ProductOrderName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ProductOrderName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Term",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "Term",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PublisherType",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PublisherType",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PublisherName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PublisherName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ChargeType",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ChargeType",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Frequency",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "Frequency",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PricingModel",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PricingModel",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AvailabilityZone",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AvailabilityZone",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingAccountId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingAccountId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingAccountName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingAccountName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingCurrencyCode",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingCurrencyCode",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingPeriodStartDate",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "name": "BillingPeriodStartDate",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingPeriodEndDate",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "name": "BillingPeriodEndDate",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingProfileId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingProfileId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingProfileName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingProfileName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "InvoiceSectionId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "InvoiceSectionId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "IsAzureCreditEligible",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "IsAzureCreditEligible",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PartNumber",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PartNumber",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PayGPrice",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PayGPrice",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PlanName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PlanName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ServiceFamily",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ServiceFamily",
                                            "type": "String"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetActualCostFilesToProcess",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "ForEachActualCostChildItem",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "SetActualCostDeleteStartDate",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        },
                                        {
                                            "activity": "SetActualCostDeleteEndDate",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "IfActualCostChildIsFolder",
                                    "type": "IfCondition",
                                    "typeProperties": {
                                        "expression": {
                                            "type": "Expression",
                                            "value": "@equals(item().type,'Folder')"
                                        },
                                        "ifTrueActivities": [
                                            {
                                                "dependsOn": [],
                                                "linkedServiceName": {
                                                    "parameters": {
                                                        "databasename": {
                                                            "type": "Expression",
                                                            "value": "@pipeline().globalParameters.costopt_sqldbname"
                                                        },
                                                        "servername": {
                                                            "type": "Expression",
                                                            "value": "@pipeline().globalParameters.costopt_sqlservername"
                                                        }
                                                    },
                                                    "referenceName": "AubiSQLDatabase",
                                                    "type": "LinkedServiceReference"
                                                },
                                                "name": "DeleteActualCostData",
                                                "policy": {
                                                    "retry": 0,
                                                    "retryIntervalInSeconds": 30,
                                                    "secureInput": false,
                                                    "secureOutput": false,
                                                    "timeout": "7.00:00:00"
                                                },
                                                "type": "SqlServerStoredProcedure",
                                                "typeProperties": {
                                                    "storedProcedureName": "[[costmanagement].[DeleteActualCostDataForDateRange]",
                                                    "storedProcedureParameters": {
                                                        "DateRangeEnd": {
                                                            "type": "DateTime",
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@variables('ActualCostDeleteEndDate')"
                                                            }
                                                        },
                                                        "DateRangeStart": {
                                                            "type": "DateTime",
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@variables('ActualCostDeleteStartDate')"
                                                            }
                                                        }
                                                    }
                                                },
                                                "userProperties": []
                                            }
                                        ]
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [],
                                    "name": "SetActualCostDeleteStartDate",
                                    "type": "SetVariable",
                                    "typeProperties": {
                                        "value": {
                                            "type": "Expression",
                                            "value": "@{substring(item().name,0,4)}-@{substring(item().name,4,2)}-@{substring(item().name,6,2)}"
                                        },
                                        "variableName": "ActualCostDeleteStartDate"
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [],
                                    "name": "SetActualCostDeleteEndDate",
                                    "type": "SetVariable",
                                    "typeProperties": {
                                        "value": {
                                            "type": "Expression",
                                            "value": "@{substring(item().name,9,4)}-@{substring(item().name,13,2)}-@{substring(item().name,15,2)}"
                                        },
                                        "variableName": "ActualCostDeleteEndDate"
                                    },
                                    "userProperties": []
                                }
                            ],
                            "isSequential": true,
                            "items": {
                                "type": "Expression",
                                "value": "@activity('GetActualCostFilesToProcess').output.childItems"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ManagePartitions",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GetActualCostFilesToProcess",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "GetMetadata",
                        "typeProperties": {
                            "dataset": {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{pipeline().parameters.ActualCostExportName}"
                                    },
                                    "File": {
                                        "type": "Expression",
                                        "value": "@trim('')"
                                    },
                                    "StorageAccount": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "CSVFileDataset",
                                "type": "DatasetReference"
                            },
                            "fieldList": [
                                "childItems",
                                "exists"
                            ],
                            "formatSettings": {
                                "type": "DelimitedTextReadSettings"
                            },
                            "storeSettings": {
                                "enablePartitionDiscovery": false,
                                "recursive": true,
                                "type": "AzureBlobStorageReadSettings"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ManagePartitions",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GetAmortizedCostFilesToProcess",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "GetMetadata",
                        "typeProperties": {
                            "dataset": {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{pipeline().parameters.AmortizedCostExportName}"
                                    },
                                    "File": {
                                        "type": "Expression",
                                        "value": "@trim('')"
                                    },
                                    "StorageAccount": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "CSVFileDataset",
                                "type": "DatasetReference"
                            },
                            "fieldList": [
                                "childItems",
                                "exists"
                            ],
                            "formatSettings": {
                                "type": "DelimitedTextReadSettings"
                            },
                            "storeSettings": {
                                "enablePartitionDiscovery": false,
                                "recursive": true,
                                "type": "AzureBlobStorageReadSettings"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetAmortizedCostFilesToProcess",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "ForEachAmortizedCostChildItem",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "SetAmortizedDeleteStartDate",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        },
                                        {
                                            "activity": "SetAmortizedDeleteEndDate",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "IfAmortizedCostChildIsFolder",
                                    "type": "IfCondition",
                                    "typeProperties": {
                                        "expression": {
                                            "type": "Expression",
                                            "value": "@equals(item().type,'Folder')"
                                        },
                                        "ifTrueActivities": [
                                            {
                                                "dependsOn": [],
                                                "linkedServiceName": {
                                                    "parameters": {
                                                        "databasename": {
                                                            "type": "Expression",
                                                            "value": "@pipeline().globalParameters.costopt_sqldbname"
                                                        },
                                                        "servername": {
                                                            "type": "Expression",
                                                            "value": "@pipeline().globalParameters.costopt_sqlservername"
                                                        }
                                                    },
                                                    "referenceName": "AubiSQLDatabase",
                                                    "type": "LinkedServiceReference"
                                                },
                                                "name": "DeleteAmortizedCostData",
                                                "policy": {
                                                    "retry": 0,
                                                    "retryIntervalInSeconds": 30,
                                                    "secureInput": false,
                                                    "secureOutput": false,
                                                    "timeout": "7.00:00:00"
                                                },
                                                "type": "SqlServerStoredProcedure",
                                                "typeProperties": {
                                                    "storedProcedureName": "[[costmanagement].[DeleteAmortizedCostDataForDateRange]",
                                                    "storedProcedureParameters": {
                                                        "DateRangeEnd": {
                                                            "type": "DateTime",
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@variables('AmortizedCostDeleteEndDate')"
                                                            }
                                                        },
                                                        "DateRangeStart": {
                                                            "type": "DateTime",
                                                            "value": {
                                                                "type": "Expression",
                                                                "value": "@variables('AmortizedCostDeleteStartDate')"
                                                            }
                                                        }
                                                    }
                                                },
                                                "userProperties": []
                                            }
                                        ]
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [],
                                    "name": "SetAmortizedDeleteStartDate",
                                    "type": "SetVariable",
                                    "typeProperties": {
                                        "value": {
                                            "type": "Expression",
                                            "value": "@{substring(item().name,0,4)}-@{substring(item().name,4,2)}-@{substring(item().name,6,2)}"
                                        },
                                        "variableName": "AmortizedCostDeleteStartDate"
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [],
                                    "name": "SetAmortizedDeleteEndDate",
                                    "type": "SetVariable",
                                    "typeProperties": {
                                        "value": {
                                            "type": "Expression",
                                            "value": "@{substring(item().name,9,4)}-@{substring(item().name,13,2)}-@{substring(item().name,15,2)}"
                                        },
                                        "variableName": "AmortizedCostDeleteEndDate"
                                    },
                                    "userProperties": []
                                }
                            ],
                            "isSequential": true,
                            "items": {
                                "type": "Expression",
                                "value": "@activity('GetAmortizedCostFilesToProcess').output.childItems"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ForEachAmortizedCostChildItem",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{pipeline().parameters.AmortizedCostExportName}"
                                    },
                                    "File": {
                                        "type": "Expression",
                                        "value": "NOTUSED"
                                    },
                                    "StorageAccount": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "CSVFileDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "LoadAmortizedCostToSQL",
                        "outputs": [
                            {
                                "parameters": {
                                    "schemaname": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.TargetSchemaName"
                                    },
                                    "sqldbname": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqldbname"
                                    },
                                    "sqlservername": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqlservername"
                                    },
                                    "tablename": {
                                        "type": "Expression",
                                        "value": "AmortizedCost"
                                    }
                                },
                                "referenceName": "costoptSQLTableDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "0.02:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "disableMetricsCollection": false,
                                "type": "AzureSqlSink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "DelimitedTextReadSettings"
                                },
                                "storeSettings": {
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings",
                                    "wildcardFileName": "*.csv",
                                    "wildcardFolderPath": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{pipeline().parameters.AmortizedCostExportName}"
                                    }
                                },
                                "type": "DelimitedTextSource"
                            },
                            "translator": {
                                "mappings": [
                                    {
                                        "sink": {
                                            "name": "InvoiceSectionName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "InvoiceSectionName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AccountName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AccountName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AccountOwnerId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AccountOwnerId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "SubscriptionId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "SubscriptionId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "SubscriptionName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "SubscriptionName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceGroup",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceGroup",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceLocation",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceLocation",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Date",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "name": "Date",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ProductName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ProductName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterCategory",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterCategory",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterSubCategory",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterSubCategory",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "MeterRegion",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "MeterRegion",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "UnitOfMeasure",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "UnitOfMeasure",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Quantity",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "Quantity",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "EffectivePrice",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "EffectivePrice",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "CostInBillingCurrency",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "CostInBillingCurrency",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "CostCenter",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "CostCenter",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ConsumedService",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ConsumedService",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Tags",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "Tags",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "OfferId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "OfferId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AdditionalInfo",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AdditionalInfo",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ServiceInfo1",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ServiceInfo1",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ServiceInfo2",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ServiceInfo2",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ResourceName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ResourceName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ReservationId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ReservationId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ReservationName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ReservationName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "UnitPrice",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "name": "UnitPrice",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ProductOrderId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ProductOrderId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ProductOrderName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ProductOrderName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Term",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "Term",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PublisherType",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PublisherType",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PublisherName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PublisherName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ChargeType",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ChargeType",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Frequency",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "Frequency",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PricingModel",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PricingModel",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "AvailabilityZone",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "AvailabilityZone",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingAccountId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingAccountId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingAccountName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingAccountName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingCurrencyCode",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingCurrencyCode",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingPeriodStartDate",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "name": "BillingPeriodStartDate",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingPeriodEndDate",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "name": "BillingPeriodEndDate",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingProfileId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingProfileId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "BillingProfileName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "BillingProfileName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "InvoiceSectionId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "InvoiceSectionId",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "IsAzureCreditEligible",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "IsAzureCreditEligible",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PartNumber",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PartNumber",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PayGPrice",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PayGPrice",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "PlanName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "PlanName",
                                            "type": "String"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "ServiceFamily",
                                            "type": "String"
                                        },
                                        "source": {
                                            "name": "ServiceFamily",
                                            "type": "String"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "ManagePartitions",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "costmanagement.addMonthPartitions"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "LoadActualCostToSQL",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "ReOrgActualCostIndex",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "[[costmanagement].[ReorganiseActualCostIndex]"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "LoadAmortizedCostToSQL",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "ReOrgAmortizedCostIndex",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "[[costmanagement].[ReorganiseAmortizedCostIndex]"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "LoadActualCostToSQL",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "description": "Move files copied into sql to processed folder.",
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{pipeline().parameters.ActualCostExportName}"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "Binary1",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "MoveActualCostExportFiles",
                        "outputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "processed/usage/scheduled_exports/@{pipeline().parameters.ActualCostExportName}"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "Binary1",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "0.12:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "type": "BinarySink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                },
                                "storeSettings": {
                                    "deleteFilesAfterCompletion": true,
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings",
                                    "wildcardFileName": "*.csv",
                                    "wildcardFolderPath": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{pipeline().parameters.ActualCostExportName}"
                                    }
                                },
                                "type": "BinarySource"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "LoadAmortizedCostToSQL",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "description": "Move files copied into sql to processed folder.",
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{pipeline().parameters.AmortizedCostExportName}"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "Binary1",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "MoveAmortizedCostExportFiles",
                        "outputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "processed/usage/scheduled_exports/@{pipeline().parameters.AmortizedCostExportName}"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "Binary1",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "0.12:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "type": "BinarySink"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                },
                                "storeSettings": {
                                    "deleteFilesAfterCompletion": true,
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings",
                                    "wildcardFileName": "*.csv",
                                    "wildcardFolderPath": {
                                        "type": "Expression",
                                        "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{pipeline().parameters.AmortizedCostExportName}"
                                    }
                                },
                                "type": "BinarySource"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ReOrgActualCostIndex",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "Update Actual Summary Table",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "[[costmanagement].[UpdateActualCostSummaryTable]",
                            "storedProcedureParameters": {
                                "DateRangeEnd": {
                                    "type": "Datetime",
                                    "value": {
                                        "type": "Expression",
                                        "value": "@adddays( utcnow(), 1)"
                                    }
                                },
                                "DateRangeStart": {
                                    "type": "Datetime",
                                    "value": {
                                        "type": "Expression",
                                        "value": "@adddays( utcnow(), -7)"
                                    }
                                }
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ReOrgAmortizedCostIndex",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "Update Amortized Summary Table",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "[[costmanagement].[UpdateAmortizedCostSummaryTable]",
                            "storedProcedureParameters": {
                                "DateRangeEnd": {
                                    "type": "Datetime",
                                    "value": {
                                        "type": "Expression",
                                        "value": "@adddays( utcnow(), 1)"
                                    }
                                },
                                "DateRangeStart": {
                                    "type": "Datetime",
                                    "value": {
                                        "type": "Expression",
                                        "value": "@adddays( utcnow(), -7)"
                                    }
                                }
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ReOrgActualCostIndex",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "Update Actual Last 30 days",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "[[costmanagement].[UpdateActualCost_Last_30_days]",
                            "storedProcedureParameters": {
                                "DateRangeEnd": {
                                    "type": "Datetime",
                                    "value": {
                                        "type": "Expression",
                                        "value": "@adddays( utcnow(), 1)"
                                    }
                                },
                                "DateRangeStart": {
                                    "type": "Datetime",
                                    "value": {
                                        "type": "Expression",
                                        "value": "@addDays( utcnow(), -31)"
                                    }
                                }
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ReOrgActualCostIndex",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "Update Tagged Resources",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "[[costmanagement].[UpdateTaggedResources]",
                            "storedProcedureParameters": {
                                "DateRangeEnd": {
                                    "type": "Datetime",
                                    "value": {
                                        "type": "Expression",
                                        "value": "@adddays( utcnow(), 1)"
                                    }
                                },
                                "DateRangeStart": {
                                    "type": "Datetime",
                                    "value": {
                                        "type": "Expression",
                                        "value": "@addDays(utcnow(), -14)"
                                    }
                                },
                                "TargetTag": {
                                    "value": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.TargetTag"
                                    }
                                }
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ReOrgAmortizedCostIndex",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "Update Amortized Last 30 days",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "[[costmanagement].[UpdateAmortizedCost_Last_30_days]",
                            "storedProcedureParameters": {
                                "DateRangeEnd": {
                                    "type": "Datetime",
                                    "value": {
                                        "type": "Expression",
                                        "value": "@adddays( utcnow(), 1)"
                                    }
                                },
                                "DateRangeStart": {
                                    "type": "Datetime",
                                    "value": {
                                        "type": "Expression",
                                        "value": "@adddays( utcnow(), -31)"
                                    }
                                }
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "description": "This pipeline looks for any usage files created by a cost management export and loads them to the database",
                "folder": {
                    "name": "UsageData"
                },
                "lastPublishTime": "2023-02-24T20:37:20Z",
                "parameters": {
                    "ActualCostExportName": {
                        "defaultValue": "WklyReportlast7days",
                        "type": "string"
                    },
                    "AmortizedCostExportName": {
                        "defaultValue": "WklyRrtAmortized",
                        "type": "string"
                    },
                    "TargetSchemaName": {
                        "defaultValue": "costmanagement",
                        "type": "string"
                    },
                    "TargetTag": {
                        "defaultValue": "ms-resource-usage",
                        "type": "string"
                    },
                    "UsageDownload_StorageBlobDirectory": {
                        "defaultValue": "download/usage",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                },
                "variables": {
                    "ActualCostDeleteEndDate": {
                        "defaultValue": "1901-01-01",
                        "type": "String"
                    },
                    "ActualCostDeleteStartDate": {
                        "defaultValue": "1901-01-01",
                        "type": "String"
                    },
                    "AmortizedCostDeleteEndDate": {
                        "defaultValue": "1901-01-01",
                        "type": "String"
                    },
                    "AmortizedCostDeleteStartDate": {
                        "defaultValue": "1901-01-01",
                        "type": "String"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/aubiAzureStorage')]"
            ],
            "name": "[concat(parameters('factoryName'), '/RIRecommendationsJson')]",
            "properties": {
                "annotations": [],
                "linkedServiceName": {
                    "parameters": {
                        "StorageAccountName": {
                            "type": "Expression",
                            "value": "@dataset().StorageAccountName"
                        }
                    },
                    "referenceName": "aubiAzureStorage",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "Container": {
                        "type": "string"
                    },
                    "StorageAccountName": {
                        "type": "string"
                    }
                },
                "schema": {},
                "type": "Json",
                "typeProperties": {
                    "location": {
                        "container": {
                            "type": "Expression",
                            "value": "@dataset().Container"
                        },
                        "type": "AzureBlobStorageLocation"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/datasets"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/pipelines/GetISFRatioDataPipeline')]",
                "[concat(variables('factoryId'), '/pipelines/LoadISFRatioToSQL')]",
                "[concat(variables('factoryId'), '/pipelines/GetMarketplaceData')]",
                "[concat(variables('factoryId'), '/pipelines/GetPriceSheet')]",
                "[concat(variables('factoryId'), '/pipelines/GetReservationRecommendationsOrchestrator')]",
                "[concat(variables('factoryId'), '/pipelines/GetReservationTransactions')]",
                "[concat(variables('factoryId'), '/pipelines/GetAdvisorData')]",
                "[concat(variables('factoryId'), '/pipelines/GetReservationDetailsOrchestrator')]",
                "[concat(variables('factoryId'), '/pipelines/LoadResDetailsToDatabase')]",
                "[concat(variables('factoryId'), '/pipelines/ProcessInboundUsageData')]"
            ],
            "name": "[concat(parameters('factoryName'), '/RefreshAllData_ExistingExports')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "name": "GetISFRatioDataPipeline",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "DownloadTargetFilename": "isfratio.csv",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/isfratio')"
                                },
                                "ISFFileURL": "https://isfratio.blob.core.windows.net/isfratio/ISFRatio.csv"
                            },
                            "pipeline": {
                                "referenceName": "GetISFRatioDataPipeline",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetISFRatioDataPipeline",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "LoadIFSRatioToSQL",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "DownloadTargetFilename": "isfratio.csv",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/isfratio')"
                                },
                                "TargetDBSchema": "costmanagement",
                                "TargetDBTable": "ISFData"
                            },
                            "pipeline": {
                                "referenceName": "LoadISFRatioToSQL",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "Set Extract End Date",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GetMarketplaceData",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "ConsumptionAPIVersion": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                },
                                "DownloadTargetFilename": "marketplace.json",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/marketplace')"
                                },
                                "UsageEndDate": {
                                    "type": "Expression",
                                    "value": "@variables('ExtractEndDate')"
                                },
                                "UsageStartDate": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.FullRefreshStartDate"
                                },
                                "scope": {
                                    "type": "Expression",
                                    "value": "providers/Microsoft.Billing/billingAccounts/@{pipeline().globalParameters.costopt_EnrollmentNumber}"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetMarketplaceData",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "GetPriceSheet",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "ConsumptionAPIVersion": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                },
                                "DownloadTargetFilename": "pricesheet.json",
                                "Download_StorageBlobContainer": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_Container"
                                },
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/pricesheet')"
                                },
                                "scope": {
                                    "type": "Expression",
                                    "value": "subscriptions/@{pipeline().globalParameters.costopt_PriceSheetSubscriptionId}"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetPriceSheet",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "Set Extract End Date",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GetReservationRecommendationsOrchestrator",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "DownloadTargetFilename": "reservation_merged.json",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/resrecommendations')"
                                },
                                "Shared_RI_FilenamePrefix": "Shared_RI_Recommendation",
                                "Single_RI_FilenamePrefix": "Single_RI_Recommendation",
                                "scope": {
                                    "type": "Expression",
                                    "value": "providers/Microsoft.Billing/billingAccounts/@{pipeline().globalParameters.costopt_EnrollmentNumber}"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetReservationRecommendationsOrchestrator",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "Set Extract End Date",
                        "type": "SetVariable",
                        "typeProperties": {
                            "value": {
                                "type": "Expression",
                                "value": "@formatDateTime(utcnow(),'yyyy-MM-dd')"
                            },
                            "variableName": "ExtractEndDate"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "Set Extract End Date",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GetReservationTransactions",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "ConsumptionAPIVersion": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                },
                                "DownloadTargetFilename": "restransactions.json",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/restransactions')"
                                },
                                "EventEndDate": {
                                    "type": "Expression",
                                    "value": "@variables('ExtractEndDate')"
                                },
                                "EventStartDate": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.FullRefreshStartDate"
                                },
                                "scope": {
                                    "type": "Expression",
                                    "value": "providers/Microsoft.Billing/billingAccounts/@{pipeline().globalParameters.costopt_EnrollmentNumber}"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetReservationTransactions",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "GetAdvisorData",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "AdvisorLoopWaitTimeSecs": 120,
                                "DownloadTargetFilename": "advisor.json",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/advisor')"
                                },
                                "GenerationWaitTimeSecs": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.AdvisorGenerationWaitSecs"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetAdvisorData",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "Set Extract End Date",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GetReservationDetailsOrchestrator",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "BillingAccountScope": {
                                    "type": "Expression",
                                    "value": "providers/Microsoft.Billing/billingAccounts/@{pipeline().globalParameters.costopt_EnrollmentNumber}"
                                },
                                "CostManagementAPIVersion": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.CostMangementReservationDetailsAPIVersion"
                                },
                                "ExtractEndDate": {
                                    "type": "Expression",
                                    "value": "@variables('ExtractEndDate')"
                                },
                                "ExtractStartDate": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.FullRefreshStartDate"
                                },
                                "ResDetailsLoopIncrement": {
                                    "type": "Expression",
                                    "value": "@int('60')"
                                },
                                "costopt_StorageDirectoryName": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/resdetails')"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetReservationDetailsOrchestrator",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetReservationDetailsOrchestrator",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "LoadResDetailsToDatabase",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "ResDetailsTargetSchema": "costmanagement",
                                "ResDetailsTargetTable": "ReservationDetails",
                                "costopt_StorageDirectoryName": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/resdetails')"
                                }
                            },
                            "pipeline": {
                                "referenceName": "LoadResDetailsToDatabase",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "ProcessInboundUsageData",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "ActualCostExportName": "msftCostManagementExportActualCost",
                                "AmortizedCostExportName": "msftCostManagementExportAmortizedCost",
                                "TargetSchemaName": "costmanagement",
                                "UsageDownload_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.UsageExportDirectory"
                                }
                            },
                            "pipeline": {
                                "referenceName": "ProcessInboundUsageData",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "description": "Use this pipeline when Cost Management Exports for ActualCost and AmortizedCost were created at deployment time.\n\nThis pipeline should be triggered after the exports have run. i.e. if the exports are scheduled to run at 10am, then run this pipeline after 11am.\nIf the Usage files dont exist, the usage data load will fail.\n\nThis pipeline executes all aubi data pipelines.\nUsage Data is obtained from the specified \n\"UsageExportDirectory\". i.e.\n\nAll other pipelines are run for startdate to end date",
                "lastPublishTime": "2023-02-24T20:37:20Z",
                "parameters": {
                    "AdvisorAPIVersionGenerateRecs": {
                        "defaultValue": "2017-04-19",
                        "type": "string"
                    },
                    "AdvisorAPIVersionGetRecs": {
                        "defaultValue": "2020-01-01",
                        "type": "string"
                    },
                    "AdvisorGenerationWaitSecs": {
                        "defaultValue": 600,
                        "type": "int"
                    },
                    "ConsumptionAPIVersion": {
                        "defaultValue": "2019-10-01",
                        "type": "string"
                    },
                    "CostManagementExportsAPIVersion": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "CostMangementReservationDetailsAPIVersion": {
                        "defaultValue": "2019-11-01",
                        "type": "string"
                    },
                    "FullRefreshStartDate": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "UsageExportDirectory": {
                        "defaultValue": "download/usage",
                        "type": "string"
                    },
                    "costopt_StorageDirectoryName": {
                        "defaultValue": "download",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                },
                "variables": {
                    "CurrentBillingPeriod": {
                        "defaultValue": "202006",
                        "type": "String"
                    },
                    "ExtractEndDate": {
                        "defaultValue": "2020-06-16",
                        "type": "String"
                    },
                    "IncrementalRefreshStartDate": {
                        "type": "String"
                    },
                    "ResDetailsLoopEndDate": {
                        "type": "String"
                    },
                    "ResDetailsLoopStartDate": {
                        "type": "String"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/pipelines/GetISFRatioDataPipeline')]",
                "[concat(variables('factoryId'), '/pipelines/LoadISFRatioToSQL')]",
                "[concat(variables('factoryId'), '/pipelines/GetMarketplaceData')]",
                "[concat(variables('factoryId'), '/pipelines/GetPriceSheet')]",
                "[concat(variables('factoryId'), '/pipelines/GetReservationRecommendationsOrchestrator')]",
                "[concat(variables('factoryId'), '/pipelines/GetReservationTransactions')]",
                "[concat(variables('factoryId'), '/pipelines/GetAdvisorData')]",
                "[concat(variables('factoryId'), '/pipelines/UsageExportOrchestrator')]",
                "[concat(variables('factoryId'), '/pipelines/GetReservationDetailsOrchestrator')]",
                "[concat(variables('factoryId'), '/pipelines/LoadResDetailsToDatabase')]"
            ],
            "name": "[concat(parameters('factoryName'), '/RefreshAllData_FullLoad')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "name": "GetISFRatioDataPipeline",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "DownloadTargetFilename": "isfratio.csv",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/isfratio')"
                                },
                                "ISFFileURL": "https://isfratio.blob.core.windows.net/isfratio/ISFRatio.csv"
                            },
                            "pipeline": {
                                "referenceName": "GetISFRatioDataPipeline",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetISFRatioDataPipeline",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "LoadIFSRatioToSQL",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "DownloadTargetFilename": "isfratio.csv",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/isfratio')"
                                },
                                "TargetDBSchema": "costmanagement",
                                "TargetDBTable": "ISFData"
                            },
                            "pipeline": {
                                "referenceName": "LoadISFRatioToSQL",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "Set Extract End Date",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GetMarketplaceData",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "ConsumptionAPIVersion": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                },
                                "DownloadTargetFilename": "marketplace.json",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/marketplace')"
                                },
                                "UsageEndDate": {
                                    "type": "Expression",
                                    "value": "@variables('ExtractEndDate')"
                                },
                                "UsageStartDate": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.FullRefreshStartDate"
                                },
                                "scope": {
                                    "type": "Expression",
                                    "value": "providers/Microsoft.Billing/billingAccounts/@{pipeline().globalParameters.costopt_EnrollmentNumber}"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetMarketplaceData",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "GetPriceSheet",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "ConsumptionAPIVersion": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                },
                                "DownloadTargetFilename": "pricesheet.json",
                                "Download_StorageBlobContainer": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_Container"
                                },
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/pricesheet')"
                                },
                                "scope": {
                                    "type": "Expression",
                                    "value": "subscriptions/@{pipeline().globalParameters.costopt_PriceSheetSubscriptionId}"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetPriceSheet",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "Set Extract End Date",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GetReservationRecommendationsOrchestrator",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "DownloadTargetFilename": "reservation_merged.json",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/resrecommendations')"
                                },
                                "Shared_RI_FilenamePrefix": "Shared_RI_Recommendation",
                                "Single_RI_FilenamePrefix": "Single_RI_Recommendation",
                                "scope": {
                                    "type": "Expression",
                                    "value": "providers/Microsoft.Billing/billingAccounts/@{pipeline().globalParameters.costopt_EnrollmentNumber}"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetReservationRecommendationsOrchestrator",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "Set Extract End Date",
                        "type": "SetVariable",
                        "typeProperties": {
                            "value": {
                                "type": "Expression",
                                "value": "@formatDateTime(utcnow(),'yyyy-MM-dd')"
                            },
                            "variableName": "ExtractEndDate"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "Set Extract End Date",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GetReservationTransactions",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "ConsumptionAPIVersion": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.ConsumptionAPIVersion"
                                },
                                "DownloadTargetFilename": "restransactions.json",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/restransactions')"
                                },
                                "EventEndDate": {
                                    "type": "Expression",
                                    "value": "@variables('ExtractEndDate')"
                                },
                                "EventStartDate": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.FullRefreshStartDate"
                                },
                                "scope": {
                                    "type": "Expression",
                                    "value": "providers/Microsoft.Billing/billingAccounts/@{pipeline().globalParameters.costopt_EnrollmentNumber}"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetReservationTransactions",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "GetAdvisorData",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "AdvisorLoopWaitTimeSecs": 120,
                                "DownloadTargetFilename": "advisor.json",
                                "Download_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/advisor')"
                                },
                                "GenerationWaitTimeSecs": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.AdvisorGenerationWaitSecs"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetAdvisorData",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "Set Incremental Refresh Start Date",
                        "type": "SetVariable",
                        "typeProperties": {
                            "value": {
                                "type": "Expression",
                                "value": "@adddays(utcnow(),mul(-1,int(pipeline().parameters.IncrementalUpdateIntervalDays)),'yyyy-MM-dd')"
                            },
                            "variableName": "IncrementalRefreshStartDate"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "Set Incremental Refresh Start Date",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "Set Extract End Date",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "UsageExportOrchestrator",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "CostManagementApiVersion": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.CostManagementExportsAPIVersion"
                                },
                                "DateRangeInterval": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.UsageExportDateRangeInterval"
                                },
                                "EndDate": {
                                    "type": "Expression",
                                    "value": "@variables('ExtractEndDate')"
                                },
                                "ExportStatusCheckLoopTime": 60,
                                "ExportTimeframe": "Custom",
                                "ExportTypeArray": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.UsageExportTypeArray"
                                },
                                "MaxExportExecutionRetries": 3,
                                "StartDate": {
                                    "type": "Expression",
                                    "value": "@variables('IncrementalRefreshStartDate')"
                                },
                                "UsageDownload_StorageBlobDirectory": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/usage')"
                                },
                                "exportName_prefix": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.exportName_prefix"
                                },
                                "scope": {
                                    "type": "Expression",
                                    "value": "providers/Microsoft.Billing/billingAccounts/@{pipeline().globalParameters.costopt_EnrollmentNumber}"
                                }
                            },
                            "pipeline": {
                                "referenceName": "UsageExportOrchestrator",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "Set Extract End Date",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "GetReservationDetailsOrchestrator",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "BillingAccountScope": {
                                    "type": "Expression",
                                    "value": "providers/Microsoft.Billing/billingAccounts/@{pipeline().globalParameters.costopt_EnrollmentNumber}"
                                },
                                "CostManagementAPIVersion": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.CostMangementReservationDetailsAPIVersion"
                                },
                                "ExtractEndDate": {
                                    "type": "Expression",
                                    "value": "@variables('ExtractEndDate')"
                                },
                                "ExtractStartDate": {
                                    "type": "Expression",
                                    "value": "@pipeline().parameters.FullRefreshStartDate"
                                },
                                "ResDetailsLoopIncrement": {
                                    "type": "Expression",
                                    "value": "@int('60')"
                                },
                                "costopt_StorageDirectoryName": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/resdetails')"
                                }
                            },
                            "pipeline": {
                                "referenceName": "GetReservationDetailsOrchestrator",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetReservationDetailsOrchestrator",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "LoadResDetailsToDatabase",
                        "type": "ExecutePipeline",
                        "typeProperties": {
                            "parameters": {
                                "ResDetailsTargetSchema": "costmanagement",
                                "ResDetailsTargetTable": "ReservationDetails",
                                "costopt_StorageDirectoryName": {
                                    "type": "Expression",
                                    "value": "@concat(pipeline().parameters.costopt_StorageDirectoryName,'/resdetails')"
                                }
                            },
                            "pipeline": {
                                "referenceName": "LoadResDetailsToDatabase",
                                "type": "PipelineReference"
                            },
                            "waitOnCompletion": true
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "description": "Use this pipeline when cost management exports have not been created.\n\nThis pipeline will create \"temporary\" exports, execute them, and then delete the exports once complete.\n\nExecutes all aubi data pipelines\nUsage Data is refreshed incrementally based on Two parameter values:\nIncrementalUpdateIntervalDays - defines how far back in time to load data from. i.e. This defines the start date for this run.\nDefaults to 7 days in the past.\n\nUsageExportDataRangeInterval - Exports will be generated with this many days of data until the end date (current date) is reached.\n\ne.g. With the defaults left as they are, each time this pipeline is run, ONE export file will be created for the previous week (7 days)\n\n\nAll other pipelines are run from:\nFullRefreshStartDate \nto \nExtract End Date (which is set to todays date)\n",
                "lastPublishTime": "2022-10-22T21:36:25Z",
                "parameters": {
                    "AdvisorAPIVersionGenerateRecs": {
                        "defaultValue": "2017-04-19",
                        "type": "string"
                    },
                    "AdvisorAPIVersionGetRecs": {
                        "defaultValue": "2020-01-01",
                        "type": "string"
                    },
                    "AdvisorGenerationWaitSecs": {
                        "defaultValue": 600,
                        "type": "int"
                    },
                    "ConsumptionAPIVersion": {
                        "defaultValue": "2019-10-01",
                        "type": "string"
                    },
                    "CostManagementExportsAPIVersion": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "CostMangementReservationDetailsAPIVersion": {
                        "defaultValue": "2019-11-01",
                        "type": "string"
                    },
                    "FullRefreshStartDate": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "IncrementalUpdateIntervalDays": {
                        "defaultValue": 7,
                        "type": "int"
                    },
                    "UsageExportDateRangeInterval": {
                        "defaultValue": 7,
                        "type": "int"
                    },
                    "UsageExportTypeArray": {
                        "defaultValue": [
                            "ActualCost",
                            "AmortizedCost"
                        ],
                        "type": "array"
                    },
                    "costopt_StorageDirectoryName": {
                        "defaultValue": "download",
                        "type": "string"
                    },
                    "exportName_prefix": {
                        "defaultValue": "msftExportUsageTemp",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                },
                "variables": {
                    "CurrentBillingPeriod": {
                        "defaultValue": "202006",
                        "type": "String"
                    },
                    "ExtractEndDate": {
                        "defaultValue": "2020-06-16",
                        "type": "String"
                    },
                    "IncrementalRefreshStartDate": {
                        "type": "String"
                    },
                    "ResDetailsLoopEndDate": {
                        "type": "String"
                    },
                    "ResDetailsLoopStartDate": {
                        "type": "String"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/aubiKeyVault')]"
            ],
            "name": "[concat(parameters('factoryName'), '/RunNamedExport')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "description": "Retrieve ClientId from Keyvault",
                        "name": "GetClientId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_clientId_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "description": "Retrieve TenantId from Keyvault",
                        "name": "GetTenantId",
                        "policy": {
                            "retry": 2,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": true,
                            "timeout": "0.00:05:00"
                        },
                        "type": "WebActivity",
                        "typeProperties": {
                            "authentication": {
                                "resource": "https://vault.azure.net",
                                "type": "MSI"
                            },
                            "headers": {},
                            "method": "GET",
                            "url": {
                                "type": "Expression",
                                "value": "https://@{pipeline().globalParameters.costopt_KeyVaultName}.vault.azure.net/secrets/@{pipeline().globalParameters.costopt_tenantid_secretname}?api-version=7.0"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "GetClientId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "GetTenantId",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "ForEach1",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "description": "Make a call to the ExportAPI to delete the named export",
                                    "name": "RunNamedExport_Pre",
                                    "policy": {
                                        "retry": 0,
                                        "retryIntervalInSeconds": 30,
                                        "secureInput": false,
                                        "secureOutput": false,
                                        "timeout": "0.00:02:00"
                                    },
                                    "type": "WebActivity",
                                    "typeProperties": {
                                        "authentication": {
                                            "password": {
                                                "secretName": {
                                                    "type": "Expression",
                                                    "value": "@pipeline().globalParameters.costopt_clientsecret_secretname"
                                                },
                                                "store": {
                                                    "parameters": {
                                                        "KeyVaultName": {
                                                            "type": "Expression",
                                                            "value": "@pipeline().globalParameters.costopt_KeyVaultName"
                                                        }
                                                    },
                                                    "referenceName": "aubiKeyVault",
                                                    "type": "LinkedServiceReference"
                                                },
                                                "type": "AzureKeyVaultSecret"
                                            },
                                            "resource": "https://management.azure.com",
                                            "type": "ServicePrincipal",
                                            "userTenant": {
                                                "type": "Expression",
                                                "value": "@activity('GetTenantId').output.value"
                                            },
                                            "username": {
                                                "type": "Expression",
                                                "value": "@activity('GetClientId').output.value"
                                            }
                                        },
                                        "body": "x",
                                        "headers": {},
                                        "method": "POST",
                                        "url": {
                                            "type": "Expression",
                                            "value": "https://management.azure.com/@{pipeline().parameters.scope}/providers/Microsoft.CostManagement/exports/@{item()}/run?api-version=@{pipeline().parameters.CostManagementApiVersion}"
                                        }
                                    },
                                    "userProperties": []
                                }
                            ],
                            "items": {
                                "type": "Expression",
                                "value": "@pipeline().parameters.exportNameArray"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "folder": {
                    "name": "UsageData"
                },
                "lastPublishTime": "2022-10-22T21:36:23Z",
                "parameters": {
                    "CostManagementApiVersion": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "exportNameArray": {
                        "defaultValue": [
                            "msftCostManagementExportAmortizedCost",
                            "msftCostManagementExportActualCost"
                        ],
                        "type": "array"
                    },
                    "scope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/57067410",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/pipelines/CreateAndRunUsageExport')]"
            ],
            "name": "[concat(parameters('factoryName'), '/UsageExportForDateRange')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [
                            {
                                "activity": "SetBatchStartDate",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "UntilEndDateReached",
                        "type": "Until",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "name": "SetBatchEndDate",
                                    "type": "SetVariable",
                                    "typeProperties": {
                                        "value": {
                                            "type": "Expression",
                                            "value": "@if( greater(adddays(variables('BatchStartDate'),pipeline().parameters.DateRangeInterval,'yyyy-MM-dd') , pipeline().parameters.EndDate)\n, pipeline().parameters.EndDate\n,adddays(variables('BatchStartDate'),pipeline().parameters.DateRangeInterval,'yyyy-MM-dd')\n)"
                                        },
                                        "variableName": "BatchEndDate"
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "SetBatchEndDate",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "AddDateRangeToProcess",
                                    "type": "AppendVariable",
                                    "typeProperties": {
                                        "value": {
                                            "type": "Expression",
                                            "value": "{\"StartDate\":\"@{variables('BatchStartDate')}\",\"EndDate\":\"@{variables('BatchEndDate')}\"}"
                                        },
                                        "variableName": "DateRangesToProcess"
                                    },
                                    "userProperties": []
                                },
                                {
                                    "dependsOn": [
                                        {
                                            "activity": "AddDateRangeToProcess",
                                            "dependencyConditions": [
                                                "Succeeded"
                                            ]
                                        }
                                    ],
                                    "name": "IncrementBatchStartDate",
                                    "type": "SetVariable",
                                    "typeProperties": {
                                        "value": {
                                            "type": "Expression",
                                            "value": "@adddays(variables('BatchEndDate'),1,'yyyy-MM-dd')"
                                        },
                                        "variableName": "BatchStartDate"
                                    },
                                    "userProperties": []
                                }
                            ],
                            "expression": {
                                "type": "Expression",
                                "value": "@greaterOrEquals(variables('BatchEndDate'),pipeline().parameters.EndDate)"
                            },
                            "timeout": "7.00:00:00"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "name": "SetBatchStartDate",
                        "type": "SetVariable",
                        "typeProperties": {
                            "value": {
                                "type": "Expression",
                                "value": "@pipeline().parameters.StartDate"
                            },
                            "variableName": "BatchStartDate"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "UntilEndDateReached",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "ForEachDateRange",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "name": "CreateAndRunUsageExport",
                                    "type": "ExecutePipeline",
                                    "typeProperties": {
                                        "parameters": {
                                            "CostManagementApiVersion": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.CostManagementApiVersion"
                                            },
                                            "EndDate": {
                                                "type": "Expression",
                                                "value": "@json(item()).EndDate"
                                            },
                                            "ExportStatusCheckLoopTime": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.ExportStatusCheckLoopTime"
                                            },
                                            "ExportTimeframe": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.ExportTimeframe"
                                            },
                                            "ExportType": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.ExportType"
                                            },
                                            "MaxExportExecutionRetries": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.MaxExportExecutionRetries"
                                            },
                                            "StartDate": {
                                                "type": "Expression",
                                                "value": "@json(item()).StartDate"
                                            },
                                            "UsageDownload_StorageBlobDirectory": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.UsageDownload_StorageBlobDirectory"
                                            },
                                            "exportName": {
                                                "type": "Expression",
                                                "value": "@{pipeline().parameters.exportName_prefix}_@{json(item()).StartDate}_@{json(item()).EndDate}_@{pipeline().parameters.ExportType}"
                                            },
                                            "scope": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.scope"
                                            }
                                        },
                                        "pipeline": {
                                            "referenceName": "CreateAndRunUsageExport",
                                            "type": "PipelineReference"
                                        },
                                        "waitOnCompletion": true
                                    },
                                    "userProperties": []
                                }
                            ],
                            "batchCount": 3,
                            "items": {
                                "type": "Expression",
                                "value": "@variables('DateRangesToProcess')"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "description": "Calls the UsageExport pipeline by breaking a large date range into smaller configurable chunks",
                "folder": {
                    "name": "UsageData"
                },
                "lastPublishTime": "2022-10-22T21:36:25Z",
                "parameters": {
                    "CostManagementApiVersion": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "DateRangeInterval": {
                        "defaultValue": 1,
                        "type": "int"
                    },
                    "EndDate": {
                        "defaultValue": "2021-09-02",
                        "type": "string"
                    },
                    "ExportStatusCheckLoopTime": {
                        "defaultValue": 60,
                        "type": "int"
                    },
                    "ExportTimeframe": {
                        "defaultValue": "Custom",
                        "type": "string"
                    },
                    "ExportType": {
                        "defaultValue": "ActualCost",
                        "type": "string"
                    },
                    "MaxExportExecutionRetries": {
                        "defaultValue": 3,
                        "type": "int"
                    },
                    "StartDate": {
                        "defaultValue": "2021-09-01",
                        "type": "string"
                    },
                    "UsageDownload_StorageBlobDirectory": {
                        "defaultValue": "download/usage",
                        "type": "string"
                    },
                    "exportName_prefix": {
                        "defaultValue": "msftExportUsageTemp",
                        "type": "string"
                    },
                    "scope": {
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                },
                "variables": {
                    "BatchEndDate": {
                        "type": "String"
                    },
                    "BatchStartDate": {
                        "type": "String"
                    },
                    "DateRangesToProcess": {
                        "type": "Array"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/AubiSQLDatabase')]",
                "[concat(variables('factoryId'), '/pipelines/UsageExportForDateRange')]"
            ],
            "name": "[concat(parameters('factoryName'), '/UsageExportOrchestrator')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [
                            {
                                "activity": "ManagePartitions",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "name": "ForEachExportType",
                        "type": "ForEach",
                        "typeProperties": {
                            "activities": [
                                {
                                    "dependsOn": [],
                                    "name": "UsageExportForDateRange",
                                    "type": "ExecutePipeline",
                                    "typeProperties": {
                                        "parameters": {
                                            "CostManagementApiVersion": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.CostManagementApiVersion"
                                            },
                                            "DateRangeInterval": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.DateRangeInterval"
                                            },
                                            "EndDate": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.EndDate"
                                            },
                                            "ExportStatusCheckLoopTime": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.ExportStatusCheckLoopTime"
                                            },
                                            "ExportTimeframe": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.ExportTimeframe"
                                            },
                                            "ExportType": {
                                                "type": "Expression",
                                                "value": "@item()"
                                            },
                                            "MaxExportExecutionRetries": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.MaxExportExecutionRetries"
                                            },
                                            "StartDate": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.StartDate"
                                            },
                                            "UsageDownload_StorageBlobDirectory": {
                                                "type": "Expression",
                                                "value": "@{pipeline().parameters.UsageDownload_StorageBlobDirectory}/@{item()}"
                                            },
                                            "exportName_prefix": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.exportName_prefix"
                                            },
                                            "scope": {
                                                "type": "Expression",
                                                "value": "@pipeline().parameters.scope"
                                            }
                                        },
                                        "pipeline": {
                                            "referenceName": "UsageExportForDateRange",
                                            "type": "PipelineReference"
                                        },
                                        "waitOnCompletion": true
                                    },
                                    "userProperties": []
                                }
                            ],
                            "batchCount": 2,
                            "items": {
                                "type": "Expression",
                                "value": "@pipeline().parameters.ExportTypeArray"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "ManagePartitions",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "costmanagement.addMonthPartitions"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ForEachExportType",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "BuildSummaryTables",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "costmanagement.BuildSummaryTables"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "BuildSummaryTables",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "ReOrganizeActualCostIndex",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "costmanagement.ReorganiseActualCostIndex"
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [
                            {
                                "activity": "ReOrganizeActualCostIndex",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "linkedServiceName": {
                            "parameters": {
                                "databasename": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqldbname"
                                },
                                "servername": {
                                    "type": "Expression",
                                    "value": "@pipeline().globalParameters.costopt_sqlservername"
                                }
                            },
                            "referenceName": "AubiSQLDatabase",
                            "type": "LinkedServiceReference"
                        },
                        "name": "ReOrganizeAmortizedCostIndex",
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "7.00:00:00"
                        },
                        "type": "SqlServerStoredProcedure",
                        "typeProperties": {
                            "storedProcedureName": "costmanagement.ReorganiseAmortizedCostIndex"
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "concurrency": 1,
                "description": "Calls the UsageExport pipeline by breaking a large date range into smaller configurable chunks",
                "folder": {
                    "name": "UsageData"
                },
                "lastPublishTime": "2022-10-22T21:36:25Z",
                "parameters": {
                    "CostManagementApiVersion": {
                        "defaultValue": "2021-01-01",
                        "type": "string"
                    },
                    "DateRangeInterval": {
                        "defaultValue": 1,
                        "type": "int"
                    },
                    "EndDate": {
                        "defaultValue": "2021-09-02",
                        "type": "string"
                    },
                    "ExportStatusCheckLoopTime": {
                        "defaultValue": 60,
                        "type": "int"
                    },
                    "ExportTimeframe": {
                        "defaultValue": "Custom",
                        "type": "string"
                    },
                    "ExportTypeArray": {
                        "defaultValue": [
                            "ActualCost",
                            "AmortizedCost"
                        ],
                        "type": "array"
                    },
                    "MaxExportExecutionRetries": {
                        "defaultValue": 3,
                        "type": "int"
                    },
                    "StartDate": {
                        "defaultValue": "2021-09-01",
                        "type": "string"
                    },
                    "UsageDownload_StorageBlobDirectory": {
                        "defaultValue": "download/usage",
                        "type": "string"
                    },
                    "exportName_prefix": {
                        "defaultValue": "msftExportUsageTemp",
                        "type": "string"
                    },
                    "scope": {
                        "defaultValue": "providers/Microsoft.Billing/billingAccounts/<BillingAccountNum>",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                },
                "variables": {
                    "BatchEndDate": {
                        "type": "String"
                    },
                    "BatchStartDate": {
                        "type": "String"
                    },
                    "DateRangesToProcess": {
                        "type": "Array"
                    },
                    "ExportEndDate": {
                        "type": "String"
                    },
                    "ExportStartDate": {
                        "type": "String"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [],
            "name": "[concat(parameters('factoryName'), '/aubiAzureStorage')]",
            "properties": {
                "annotations": [],
                "description": "Data retrieved from the Billing APIs will be written to this Azure Storage account",
                "parameters": {
                    "StorageAccountName": {
                        "defaultValue": "cfmdefaultsa",
                        "type": "String"
                    }
                },
                "type": "AzureBlobStorage",
                "typeProperties": {
                    "serviceEndpoint": "[parameters('aubiAzureStorage_properties_typeProperties_serviceEndpoint')]"
                }
            },
            "type": "Microsoft.DataFactory/factories/linkedServices"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [],
            "name": "[concat(parameters('factoryName'), '/aubiKeyVault')]",
            "properties": {
                "annotations": [],
                "description": "Key Vault containing secrets required to authenticate to the billing apis",
                "parameters": {
                    "KeyVaultName": {
                        "defaultValue": "CFMKeyVault",
                        "type": "string"
                    }
                },
                "type": "AzureKeyVault",
                "typeProperties": {
                    "baseUrl": "[parameters('aubiKeyVault_properties_typeProperties_baseUrl')]"
                }
            },
            "type": "Microsoft.DataFactory/factories/linkedServices"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/AubiSQLDatabase')]"
            ],
            "name": "[concat(parameters('factoryName'), '/aubiSQLTableDataset')]",
            "properties": {
                "annotations": [],
                "folder": {
                    "name": "ProcessUsageData"
                },
                "linkedServiceName": {
                    "parameters": {
                        "databasename": {
                            "type": "Expression",
                            "value": "@dataset().sqldbname"
                        },
                        "servername": {
                            "type": "Expression",
                            "value": "@dataset().sqlservername"
                        }
                    },
                    "referenceName": "AubiSQLDatabase",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "schemaname": {
                        "defaultValue": "aubi",
                        "type": "string"
                    },
                    "sqldbname": {
                        "defaultValue": "aubisqldb",
                        "type": "string"
                    },
                    "sqlservername": {
                        "defaultValue": "aubisqlserver",
                        "type": "string"
                    },
                    "tablename": {
                        "defaultValue": "AzureUsageData",
                        "type": "string"
                    }
                },
                "schema": [],
                "type": "AzureSqlTable",
                "typeProperties": {
                    "schema": {
                        "type": "Expression",
                        "value": "@dataset().schemaname"
                    },
                    "table": {
                        "type": "Expression",
                        "value": "@dataset().tablename"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/datasets"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/AubiSQLDatabase')]"
            ],
            "name": "[concat(parameters('factoryName'), '/costoptSQLTableDataset')]",
            "properties": {
                "annotations": [],
                "folder": {
                    "name": "ProcessUsageData"
                },
                "linkedServiceName": {
                    "parameters": {
                        "databasename": {
                            "type": "Expression",
                            "value": "@dataset().sqldbname"
                        },
                        "servername": {
                            "type": "Expression",
                            "value": "@dataset().sqlservername"
                        }
                    },
                    "referenceName": "AubiSQLDatabase",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "schemaname": {
                        "type": "string"
                    },
                    "sqldbname": {
                        "type": "string"
                    },
                    "sqlservername": {
                        "type": "string"
                    },
                    "tablename": {
                        "type": "string"
                    }
                },
                "schema": [],
                "type": "AzureSqlTable",
                "typeProperties": {
                    "schema": {
                        "type": "Expression",
                        "value": "@dataset().schemaname"
                    },
                    "table": {
                        "type": "Expression",
                        "value": "@dataset().tablename"
                    }
                }
            },
            "type": "Microsoft.DataFactory/factories/datasets"
        },
        {
            "apiVersion": "2018-06-01",
            "dependsOn": [
                "[concat(variables('factoryId'), '/datasets/JsonDataset')]",
                "[concat(variables('factoryId'), '/datasets/costoptSQLTableDataset')]"
            ],
            "name": "[concat(parameters('factoryName'), '/schema_patch_v6_0_20230216')]",
            "properties": {
                "activities": [
                    {
                        "dependsOn": [],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.RegionsDirectoryPath"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.RegionsFileName"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "Copy Region Data",
                        "outputs": [
                            {
                                "parameters": {
                                    "schemaname": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.TargetSchemaName"
                                    },
                                    "sqldbname": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqldbname"
                                    },
                                    "sqlservername": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqlservername"
                                    },
                                    "tablename": "Regions"
                                },
                                "referenceName": "costoptSQLTableDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "0.12:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "sqlWriterUseTableLock": false,
                                "type": "AzureSqlSink",
                                "writeBehavior": "insert"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "JsonReadSettings"
                                },
                                "storeSettings": {
                                    "enablePartitionDiscovery": false,
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings"
                                },
                                "type": "JsonSource"
                            },
                            "translator": {
                                "mappings": [
                                    {
                                        "sink": {
                                            "name": "displayName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['displayName']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "id",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['id']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "geographyGroup",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['metadata']['geographyGroup']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "latitude",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "path": "$['metadata']['latitude']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "longitude",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "path": "$['metadata']['longitude']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "physicalLocation",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['metadata']['physicalLocation']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "regionCategory",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['metadata']['regionCategory']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "regionType",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['metadata']['regionType']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "pairedRegion",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['metadata']['pairedRegion'][0]['name']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "name",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['name']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "regionalDisplayName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['regionalDisplayName']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "subscriptionId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['subscriptionId']"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.AdvisorDirectoryPath"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.AdvisorFileName"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "Copy Advisor Data",
                        "outputs": [
                            {
                                "parameters": {
                                    "schemaname": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.TargetSchemaName"
                                    },
                                    "sqldbname": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqldbname"
                                    },
                                    "sqlservername": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqlservername"
                                    },
                                    "tablename": "Advisor"
                                },
                                "referenceName": "costoptSQLTableDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "0.12:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "sqlWriterUseTableLock": false,
                                "type": "AzureSqlSink",
                                "writeBehavior": "insert"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "JsonReadSettings"
                                },
                                "storeSettings": {
                                    "enablePartitionDiscovery": false,
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings"
                                },
                                "type": "JsonSource"
                            },
                            "translator": {
                                "collectionReference": "$['value']",
                                "mappings": [
                                    {
                                        "sink": {
                                            "name": "Impacted Resource Name",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "[['properties']['impactedValue']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Impacted Resource Type",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "[['properties']['impactedField']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Last Updated",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "path": "[['properties']['lastUpdated']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Short Description - Problem",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "[['properties']['shortDescription']['problem']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "Short Description - Solution",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "[['properties']['shortDescription']['solution']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "resourceId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "[['properties']['resourceMetadata']['resourceId']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "recommendationTypeId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "[['properties']['recommendationTypeId']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "type",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "[['type']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "name",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "[['name']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "source",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "[['resourceMetadata']['source']"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator"
                            }
                        },
                        "userProperties": []
                    },
                    {
                        "dependsOn": [],
                        "inputs": [
                            {
                                "parameters": {
                                    "Container": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_Container"
                                    },
                                    "Directory": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.ReservationsDirectoryPath"
                                    },
                                    "FileName": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.ReservationsFileName"
                                    },
                                    "StorageAccountName": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_StorageAccountName"
                                    }
                                },
                                "referenceName": "JsonDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "name": "Copy Reservation Transactions",
                        "outputs": [
                            {
                                "parameters": {
                                    "schemaname": {
                                        "type": "Expression",
                                        "value": "@pipeline().parameters.TargetSchemaName"
                                    },
                                    "sqldbname": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqldbname"
                                    },
                                    "sqlservername": {
                                        "type": "Expression",
                                        "value": "@pipeline().globalParameters.costopt_sqlservername"
                                    },
                                    "tablename": "Reservation Transactions"
                                },
                                "referenceName": "costoptSQLTableDataset",
                                "type": "DatasetReference"
                            }
                        ],
                        "policy": {
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureInput": false,
                            "secureOutput": false,
                            "timeout": "0.12:00:00"
                        },
                        "type": "Copy",
                        "typeProperties": {
                            "enableStaging": false,
                            "sink": {
                                "sqlWriterUseTableLock": false,
                                "type": "AzureSqlSink",
                                "writeBehavior": "insert"
                            },
                            "source": {
                                "formatSettings": {
                                    "type": "JsonReadSettings"
                                },
                                "storeSettings": {
                                    "enablePartitionDiscovery": false,
                                    "recursive": true,
                                    "type": "AzureBlobStorageReadSettings"
                                },
                                "type": "JsonSource"
                            },
                            "translator": {
                                "collectionReference": "",
                                "mappings": [
                                    {
                                        "sink": {
                                            "name": "id",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['id']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "name",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['name']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "type",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['type']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "tags",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['tags'][*]"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "billingFrequency",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['billingFrequency']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "purchasingEnrollment",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['purchasingEnrollment']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "armSkuName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['armSkuName']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "term",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['term']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "region",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['region']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "purchasingSubscriptionGuid",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['purchasingSubscriptionGuid']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "purchasingSubscriptionName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['purchasingSubscriptionName']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "accountName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['accountName']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "accountOwnerEmail",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['accountOwnerEmail']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "departmentName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['departmentName']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "costCenter",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['costCenter']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "currentEnrollment",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['currentEnrollment']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "eventDate",
                                            "type": "DateTime"
                                        },
                                        "source": {
                                            "path": "$['properties']['eventDate']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "reservationOrderId",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['reservationOrderId']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "description",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['description']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "eventType",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['eventType']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "quantity",
                                            "type": "Int32"
                                        },
                                        "source": {
                                            "path": "$['properties']['quantity']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "amount",
                                            "type": "Decimal"
                                        },
                                        "source": {
                                            "path": "$['properties']['amount']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "currency",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['currency']"
                                        }
                                    },
                                    {
                                        "sink": {
                                            "name": "reservationOrderName",
                                            "type": "String"
                                        },
                                        "source": {
                                            "path": "$['properties']['reservationOrderName']"
                                        }
                                    }
                                ],
                                "type": "TabularTranslator"
                            }
                        },
                        "userProperties": []
                    }
                ],
                "annotations": [],
                "description": "Various tables. \nv6.0.20230216",
                "folder": {
                    "name": "00Debug"
                },
                "lastPublishTime": "2023-02-24T20:21:29Z",
                "parameters": {
                    "AdvisorDirectoryPath": {
                        "defaultValue": "download/advisor/merged",
                        "type": "string"
                    },
                    "AdvisorFileName": {
                        "defaultValue": "advisor.json",
                        "type": "string"
                    },
                    "RegionsDirectoryPath": {
                        "defaultValue": "download/regions",
                        "type": "string"
                    },
                    "RegionsFileName": {
                        "defaultValue": "azure regionsv2.json",
                        "type": "string"
                    },
                    "ReservationsDirectoryPath": {
                        "defaultValue": "download/restransactions",
                        "type": "string"
                    },
                    "ReservationsFileName": {
                        "defaultValue": "restransactions.json",
                        "type": "string"
                    },
                    "TargetSchemaName": {
                        "defaultValue": "costmanagement",
                        "type": "string"
                    }
                },
                "policy": {
                    "cancelAfter": {},
                    "elapsedTimeMetric": {}
                }
            },
            "type": "Microsoft.DataFactory/factories/pipelines"
        }
    ],
    "variables": {
        "factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
    }
}
