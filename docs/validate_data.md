# Validate Data

This is the source of truth for the Azure billing data.

* The specific source of the data is found in [Source Version](#source-version).
* It is generated by following [Steps to Recreate](#steps-to-recreate).

**Actual**
| Usage Date | Portal UI  | Portal Download CostUSD | Portal Download Cost | File Download  | Monthly File | API Call           | SQL Table     | SQL Summary   |
|------------|------------|-------------------------|----------------------|----------------|--------------|--------------------|---------------|---------------|
| 2020-12    |            |                         |                      |                |              |                    |               |               |
| 2021-01    |            |                         |                      |                |              |                    |               |               |

**Amortized**
| Usage Date | Portal UI  | Portal Download CostUSD | Portal Download Cost | File Download    | Monthly File | API Call           | SQL Table      | SQL Summary    |
|------------|------------|-------------------------|----------------------|------------------|--------------|--------------------|----------------|----------------|
| 2021-06    |            |                         |                      |                  |              |                    |                |                |
| 2021-07    |            |                         |                      |                  |              |                    |                |                |
| 2021-08    |            |                         |                      |                  |              |                    |                |                |

**Gov Actual**
| Usage Date | Portal UI  | Portal Download CostUSD | Portal Download Cost | File Download    | Monthly File | API Call           | SQL Table      | SQL Summary    |
|------------|------------|-------------------------|----------------------|------------------|--------------|--------------------|----------------|----------------|
| 2021-06    |            |                         |                      |                  |              |                    |                |                |
| 2021-07    |            |                         |                      |                  |              |                    |                |                |
| 2021-08    |            |                         |                      |                  |              |                    |                |                |

**Gov Amortized**
| Usage Date | Portal UI  | Portal Download CostUSD | Portal Download Cost | File Download    | Monthly File | API Call           | SQL Table      | SQL Summary    |
|------------|------------|-------------------------|----------------------|------------------|--------------|--------------------|----------------|----------------|
| 2021-06    |            |                         |                      |                  |              |                    |                |                |
| 2021-07    |            |                         |                      |                  |              |                    |                |                |
| 2021-08    |            |                         |                      |                  |              |                    |                |                |

# Source Version

| Source | Version |
|--------|---------|
| Portal Download CostUSD | 20230505 |
| Portal UI               | 20230505 |
| File Download           | See File Download Version |
| API Call                |  TBD          |
| SQL DB                  | 20230508.1817 |
| Actual 2022-12    | CostManagementExportActualCost_55773521-07b0-481c-9427-efe5898721dc.csv.v20230505T201005.csv  |

# Steps to Recreate

## Portal UI

* Navigate to [Cost Management -> Cost analysis](https://portal.azure.com/#view/Microsoft_Azure_CostManagement/CostAnalysis/scope/%2Fproviders%2FMicrosoft.Management%2FmanagementGroups%2Frootmanagementgroup_v2/isAcmContext~/true/viewId/%2Fproviders%2FMicrosoft.Management%2FmanagementGroups%2Frootmanagementgroup_v2%2Fproviders%2FMicrosoft.CostManagement%2Fviews%2Fms%3ADailyCosts/openByNewTab~/true)
* Select Correct Scope
* Create view both Actual cost and Amortized Cost
* Select the Date range `2022-12-01` to `2023-04-30`
* Group by `None`
* Granularity: `Monthly`
* Hover the mouse over each column to read the value

## Portal Download

Follow Portal UI instructions and then Select `Download` for the csv file

## File Download

Download the file and calculate the values.

```bash
# Get local file
./script/stage_files --cost_type actual --month 202301 --local
# Get cost and row count
./script/validate_data --cost_type actual --month 202301

# or
python ./script/validate_data.py --cost_type actual --month 202301
```

## API Download


## SQL Download

Run the following script on the database
```sql
SELECT '---------Check Month Values --------------------'
DECLARE @DateRangeStart date;
DECLARE @DateRangeEnd date
SELECT @DateRangeStart = '2022-12-01'
SELECT @DateRangeEnd = '2023-05-30'

SELECT
    N'Validate Actual Cost' as Meta
    , YEAR([ActualCost].[Date]) as BillingYear
    , MONTH([ActualCost].[Date]) AS BillingMonth
	, MIN([Date]) AS MinDate
	, MAX([Date]) AS MaxDate
    , CONVERT(
        varchar, CONVERT(money, Sum([ActualCost].CostInBillingCurrency)), 1
    ) AS Cost
FROM
    [costmanagement].[ActualCost]
WHERE [ActualCost].[Date] >= @DateRangeStart AND [ActualCost].[Date] <= @DateRangeEnd
GROUP BY
    YEAR([Date]), MONTH([Date])
UNION
SELECT
    N'Validate Actual Cost Summary' as Meta
    , YEAR([Date]) as BillingYear
    , MONTH([Date]) AS BillingMonth
	, MIN([Date]) AS MinDate
	, MAX([Date]) AS MaxDate
    , CONVERT(
        varchar, CONVERT(money, Sum(CostInBillingCurrency)), 1
    ) AS Cost
FROM
    [costmanagement].[ActualCostSummary]
WHERE [Date] >= @DateRangeStart AND [Date] <= @DateRangeEnd
GROUP BY
    YEAR([Date]), MONTH([Date])
UNION
SELECT
    N'Validate Amortized Cost' as Meta
    , YEAR([Date]) as BillingYear
    , MONTH([Date]) AS BillingMonth
	, MIN([Date]) AS MinDate
	, MAX([Date]) AS MaxDate
    , CONVERT(
        varchar, CONVERT(money, Sum(CostInBillingCurrency)), 1
    ) AS Cost
FROM
    [costmanagement].[AmortizedCost]
WHERE [Date] >= @DateRangeStart AND [Date] <= @DateRangeEnd
GROUP BY
    YEAR([Date]), MONTH([Date])
UNION
SELECT
    N'Validate Amortized Cost Summary' as Meta
    , YEAR([Date]) as BillingYear
    , MONTH([Date]) AS BillingMonth
	, MIN([Date]) AS MinDate
	, MAX([Date]) AS MaxDate
    , CONVERT(
        varchar, CONVERT(money, Sum(CostInBillingCurrency)), 1
    ) AS Cost
FROM
    [costmanagement].[AmortizedCostSummary]
WHERE [Date] >= @DateRangeStart AND [Date] <= @DateRangeEnd
GROUP BY
    YEAR([Date]), MONTH([Date])
GO
```
